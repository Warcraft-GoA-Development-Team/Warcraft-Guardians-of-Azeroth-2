union_story_cycle = {
	on_setup = {
		#set_variable = { name = this_union value = flag:alliance }
		add_to_variable_list = {
			name = union_members
			target = story_owner
		}
	}

	on_end = {
	}

	on_owner_death = {
	}

	#Centralization update
	effect_group = {
		years = 1
		triggered_effect = {
			trigger = {
				story_owner = { is_alive = yes }
			}
			effect = {
				#update centralization
				change_variable = { name = centralization_value add = story_owner.centralization_influencce_value }
				if = {
					limit = { var:centralization_value > 100 }
					set_variable = { name = centralization_value value = 100 }
				}
				else_if = {
					limit = { var:centralization_value < -100 }
					set_variable = { name = centralization_value value = -100 }
				}
				#update modifiers
				if = {
					limit = { var:centralization_value >= 100 }
					update_union_modifier = { union_modifier = modifier_100_pos }
				}
				else_if = {
					limit = { var:centralization_value >= 75 var:centralization_value < 100 }
					update_union_modifier = { union_modifier = modifier_75_pos }
				}
				else_if = {
					limit = { var:centralization_value >= 50 var:centralization_value < 75 }
					update_union_modifier = { union_modifier = modifier_50_pos }
				}
				else_if = {
					limit = { var:centralization_value >= 25 var:centralization_value < 50 }
					update_union_modifier = { union_modifier = modifier_25_pos }
				}
				else_if = {
					limit = { var:centralization_value > -25 var:centralization_value < 25 }
					update_union_modifier = { union_modifier = modifier_0 }
				}
				else_if = {
					limit = { var:centralization_value > -50 var:centralization_value <= -25 }
					update_union_modifier = { union_modifier = modifier_25_neg }
				}
				else_if = {
					limit = { var:centralization_value > -75 var:centralization_value <= -50 }
					update_union_modifier = { union_modifier = modifier_50_neg }
				}
				else_if = {
					limit = { var:centralization_value > -100 var:centralization_value <= -75 }
					update_union_modifier = { union_modifier = modifier_75_neg }
				}
				else = {
					update_union_modifier = { union_modifier = modifier_100_neg }
				}
			}
		}
	}
	effect_group = {
		months = 3

		### in case of some bug with union leader
		triggered_effect = {
			trigger = {
				story_owner = {
					is_alive = no
				}
			}
			effect = {
				if = {
					limit = {
						has_variable_list = union_members
						any_in_list = {
							variable = union_members
							is_alive = yes
							can_lead_union_trigger = { landless = no }
						}
					}
					random_in_list = {
						variable = union_members
						limit = {
							is_alive = yes
							can_lead_union_trigger = { landless = no }
						}
						root = { make_story_owner = prev }
					}
					if = {
						limit = { var:this_union = flag:custom }
						set_global_variable = { name = custom_leader value = story_owner }
					}
				}
				else = {
					every_in_list = {
						variable = union_members
						limit = {
							is_alive = yes
						}
						add_to_list = former_union_members
						set_variable = { name = former_union value = root.var:this_union days = 365 }
						
						leave_this_union_effect = yes
					}
					add_union_creation_cooldown_base_effect = yes
					remove_list_global_variable = {
						name = all_unions
						target = this
					}
					end_story = yes
				}
			}
		}
	}
	effect_group = {
		months = { 8 9 }
		
		### in case of some bugs, remove (dead person/bugged with another union/bugged without variable) from union member list
		triggered_effect = {
			trigger = {
				has_variable_list = union_members
				any_in_list = {
					variable = union_members
					OR = {
						is_alive = no
						NOT = { has_variable = this_union }
						NOT = { var:this_union = root.var:this_union }
					}
				}
			}
			effect = {
				every_in_list = {
					variable = union_members
					limit = {
						OR = {
							is_alive = no
							NOT = { has_variable = this_union }
							NOT = { var:this_union = root.var:this_union }
						}
					}
					root = { remove_list_variable = { name = union_members target = prev } }
				}
			}
		}
		### State colors fixing if have game rule
		# if holder is not in union for some reason, or this title is not a primary title anymore, restore default color
		triggered_effect = {
			trigger = {
				has_game_rule = wc_unified_union_color_enabled
				has_variable_list = colored_titles
				any_in_list = {
					variable = colored_titles
					OR = {
						NOT = { exists = holder }
						NAND = {
							holder = {
								has_variable = this_union
								var:this_union = root.var:this_union
							}
						}
						NOT = { this = holder.primary_title }
					}
				}
			}
			effect = {
				every_in_list = {
					variable = colored_titles
					limit = {
						OR = {
							NOT = { exists = holder }
							NAND = {
								holder = {
									has_variable = this_union
									var:this_union = root.var:this_union
								}
							}
							NOT = { this = holder.primary_title }
						}
					}
					set_my_default_color_effect = yes
					root = { remove_list_variable = { name = colored_titles target = prev } }
				}
			}
		}
		# If union member changed his primary title, give the color to the new primary one
		triggered_effect = {
			trigger = {
				has_game_rule = wc_unified_union_color_enabled
				has_variable_list = union_members
				any_in_list = {
					variable = union_members
					primary_title = { NOT = { has_variable = my_default_color } }
				}
			}
			effect = {
				save_temporary_scope_as = union_scope
				every_in_list = {
					variable = union_members
					limit = { primary_title = { NOT = { has_variable = my_default_color } } }
					primary_title = { save_title_color_create_dummy_title_effect = { from_union = union_scope } }
					root = { add_to_variable_list = { name = colored_titles target = prev } }
				}
			}
		}
	}
	### Election campaign funds, not real gold/prestige to not mess up their economics
	effect_group = {
		months = { 3 4 }
		triggered_effect = {
			trigger = {
				has_variable_list = union_members
			}
			effect = {
				every_in_list = {
					variable = union_members
					limit = { is_alive = yes is_ai = yes }
					if = {
						limit = {
							this = root.story_owner
							exists = primary_heir
							primary_heir = {
								NOT = { has_variable = this_union }
							}
						}
						primary_heir = {
							random = {
								chance = 5
								modifier = {
									add = 20
									has_trait = ambitious
								}
								modifier = {
									add = 5
									is_ruler = yes
									prev.highest_held_title_tier >= tier_kingdom
								}
								modifier = {
									add = 10
									is_ruler = yes
									prev.highest_held_title_tier = tier_empire
								}
								if = {
									limit = { has_variable = campaign_fund var:campaign_fund >= 5000 }
									#Do nothing, 5000 is max for ai
								}
								else_if = {
									limit = { has_variable = campaign_fund }
									change_variable = { name = campaign_fund add = 200 }
								}
								else = { set_variable = { name = campaign_fund value = 200 } }
							}
						}
					}
					else = {
						random = {
							chance = 5
							modifier = {
								add = 20
								has_trait = ambitious
							}
							modifier = {
								add = 5
								is_ruler = yes
								highest_held_title_tier >= tier_kingdom
							}
							modifier = {
								add = 10
								is_ruler = yes
								highest_held_title_tier = tier_empire
							}
							if = {
								limit = { has_variable = campaign_fund var:campaign_fund >= 5000 }
								#Do nothing, 5000 is max for ai
							}
							else_if = {
								limit = { has_variable = campaign_fund }
								change_variable = { name = campaign_fund add = 200 }
							}
							else = { set_variable = { name = campaign_fund value = 200 } }
						}
					}
				}
			}
		}
	}
}
