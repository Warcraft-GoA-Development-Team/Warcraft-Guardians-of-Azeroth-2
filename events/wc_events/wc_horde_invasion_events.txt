namespace = wc_horde_invasion

##################################################
# Sacking of Northshire
# by Dione and ElMariuso
##################################################

# Conquering of Northshire
wc_horde_invasion.0001 = {
	title = wc_horde_invasion.0001.title
	desc = wc_horde_invasion.0001.desc
	type = character_event
	theme = war
	
	override_background = { reference = burning_building }
	
	left_portrait = {
		character = root
		animation = celebrate_axe
	}
	
	#right_portrait = {
	#	character = scope:previous_controller
	#	animation = fear
	#}
	
	#Kill them all!
	option = {
		name = wc_horde_invasion.0001.a
		custom_tooltip = wc_horde_invasion.0001.tooltip.a
		
		custom_tooltip = previoush_tt
		hidden_effect = {
			every_hired_mercenary  = { #Gets mercenaries hired by the Player
				mercenary_company_leader = {
					every_courtier = {
						add_to_temporary_list = hired_characters
					}
					every_vassal_or_below = {
						add_to_temporary_list = hired_characters
					}
					add_to_temporary_list = hired_characters
				}
			}
			every_patroned_holy_order = {
				leader = {
					add_to_temporary_list = hired_characters
				}
			}
			every_vassal_or_below = {
				every_patroned_holy_order = {
					leader = {
						add_to_temporary_list = hired_characters
					}
				}
			}
			scope:barony.title_province = {
				every_character_in_location = {
					limit = {
						NOR = {
							this = root
							is_vassal_or_below_of = root
							employer = root
							is_courtier_of = root
							is_in_list = hired_characters
						}
					}
					save_scope_as = victim
					random_list = {
						15 = {
							# Live
						}
						20 = { 
							# Slave
							prisoner_of_war_capture_effect = {
								TARGET = scope:victim
								IMPRISONER = root
							}
						}
						65 = {
							override_death_killer_effect = {
								death_reason = death_horde
								killer = root
							}
						}
					}
				}
			}
		}
	}
}

wc_horde_invasion.00010 = {
	title = wc_horde_invasion.00010.title
	desc = wc_horde_invasion.00010.desc
	type = character_event
	theme = war

	left_portrait = {
		character = root
		animation = personality_honorable
	}

	immediate = {
		title:e_horde.holder = { save_scope_as = horde_leader }
	}

	# Sack the city
	option = {
		name = wc_horde_invasion.00010.a
		custom_tooltip = wc_horde_invasion.00010.tooltip.a

		#sack_area_effect = {
		#	TITLE = title:c_northshire
		#	TITLE_TIER = county
		#	DESTROY_HOLY_ORDERS = yes
		#	HOLDING_TYPE = tribal_holding
		#}

		# artifacts? - not sure which ones yet
		
		spawn_army = { # 1000 
			uses_supply = no
			inheritable = no
			name = remnants_northshire
			levies = 200
			location = title:b_northshire.title_province
			origin = title:b_northshire.title_province
			men_at_arms = { # 300
				type = armored_horsemen
				stacks = 6
			}
			men_at_arms = { # 500
				type = armored_footmen
				stacks = 5
			}
		}
		
		custom_tooltip = previoush_tt
		hidden_effect = {
			scope:previous_holder = {
				override_death_killer_effect = {
					death_reason = death_battle
					killer = scope:horde_leader
				}
			}
		}
		
		set_global_variable = {
			name = brotherhood_northshire_destroyed
			value = yes 
		}

		ai_chance = {
			base = 100
			modifier = {
				add = 50
				OR = {
					has_trait = wrathful
					has_trait = vengeful
					has_trait = greedy
					has_trait = callous
				}
			}
		}

		#every_vassal_or_below = {
		#	trigger_event = {
		#		id = WCWAR.25
		#		days = 2
		#	}
		#}
	}

	# Keep it how it is
	option = {
		name = wc_horde_invasion.00010.b
		custom_tooltip = wc_horde_invasion.00010.tooltip.b
		
		ai_chance = {
			base = 10
			modifier = {
				add = 100
				has_trait = compassionate
			}
		}
	}
}

# Notification for Horde Vassals
wc_horde_invasion.0002 = {
	title = wc_horde_invasion.0002.title
	desc = {
		desc = wc_horde_invasion.0002.desc
		first_valid = {
			triggered_desc = {
				trigger = {
					has_title = title:d_twilights_hammer_clan
				}
				desc = wc_horde_invasion.0002.desc.twilight_hammer
			}
		}
	}

	type = character_event
	theme = war

	immediate = {
		title:c_northshire = { save_scope_as = northshire }
		title:e_horde.holder = { save_scope_as = horde_leader }
	}

	left_portrait = {
		character = scope:horde_leader
		animation = personality_honorable
	}

	right_portrait = {
		character = root
		animation = thinking
	}

	# ok
	option = {
		name = wc_horde_invasion.0002.a
		add_short_term_gold = 10
	}

	# Ask for lands
	option = {
		name = wc_horde_invasion.0002.b

		trigger = {
			has_title = title:d_twilights_hammer_clan
		}

		custom_tooltip = ask_for_lands_tt

		scope:horde_leader = {
			title:d_twilights_hammer_clan.holder = {
				save_scope_as = twilight_holder
			}
			#trigger_event = {
			#	id = WCWAR.30
			#	days = 1
			#}
		}

		ai_chance = {
			base = 100
			modifier = {
				add = 1000
				has_title = title:d_twilights_hammer_clan
			}
		}
	}
}

# Asking for lands (notification for horde leader)
wc_horde_invasion.0003 = {
	title = wc_horde_invasion.0003.title
	desc = wc_horde_invasion.0003.desc

	type = character_event
	theme = war

	left_portrait = {
		character = root
		animation = thinking
	}

	right_portrait = {
		character = scope:twilight_holder
		animation = beg
	}

	# yes
	option = {
		name = wc_horde_invasion.0003.a
		ai_chance = {
			base = 100
			modifier = {
				add = 50
				OR = {
					has_trait = zealous
					has_trait = compassionate
				}
			}
		}
	}

	# n o
	option = {
		name = wc_horde_invasion.0003.b
		add_character_flag = {
			flag = no_northshire
			days = 30
		}

		ai_chance = {
			base = 10
			modifier = {
				add = 100
				OR = {
					has_trait = callous
					has_trait = greedy
				}
			}
		}
	}

	after = {
		scope:horde_leader = {
			every_vassal_or_below = {
				#trigger_event = {
				#	id = WCWAR.35
				#	days = 5
				#}
			}
		}
	}
}

# Asking for lands notification + response
wc_horde_invasion.0004 = {
	title = wc_horde_invasion.0004.title
	type = character_event
	theme = war
	left_portrait = {
		character = root
		animation = personality_honorable
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { 
					NOT = { this = scope:twilight_holder }
					NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
				}
				desc = wc_horde_invasion.0004.desc
			}
			triggered_desc = {
				trigger = { 
					this = scope:twilight_holder
					scope:horde_leader = { has_character_flag = no_northshire }
				}
				desc = wc_horde_invasion.0004.desc.fail
			}
			triggered_desc = {
				trigger = { 
					this = scope:twilight_holder
					NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
				}
				desc = wc_horde_invasion.0004.desc.success
			}
		}
	}

	immediate = {
		title:c_northshire = { save_scope_as = northshire }
		title:e_horde.holder = { save_scope_as = horde_leader }
		title:d_twilights_hammer_clan.holder = { save_scope_as = twilight_holder }
	}

	trigger = {
		#only notify vassals if twilight's hammer leader gets the land
		OR = {
			this = scope:twilight_holder
			NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
		}
	}

	# ok
	option = {
		name = wc_horde_invasion.0004.a
		trigger = {
			NOT = { this = scope:twilight_holder }
		}
	}

	# good
	option = {
		name = wc_horde_invasion.0004.b
		trigger = {
			this = scope:twilight_holder
			NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
		}
	}

	# bad 
	option = {
		name = wc_horde_invasion.0004.b
		trigger = {
			this = scope:twilight_holder
			scope:horde_leader = { has_character_flag = no_northshire } 
		}

		stress_impact = {
			base = medium_stress_impact_gain
		}
	}

	after = {
		if = {
			limit = { NOT = { scope:horde_leader = { has_character_flag = no_northshire } } }
			scope:twilight_holder = {
				create_title_and_vassal_change = {
					type = granted
					save_scope_as = change
					add_claim_on_loss = no
				}
				scope:northshire = {
					change_title_holder = {
						holder = scope:twilight_holder
						change = scope:change
					}
				}

				resolve_title_and_vassal_change = scope:change
				set_realm_capital = title:c_northshire
			}			
		}
	}
}