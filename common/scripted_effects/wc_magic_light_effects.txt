init_light_spells_effect = {
    add_to_global_variable_list = { name = light_spells target = flag:flash_of_light }
    add_to_global_variable_list = { name = light_spells target = flag:dispel }
    add_to_global_variable_list = { name = light_spells target = flag:holy_fire }
    add_to_global_variable_list = { name = light_spells target = flag:lightwell }
    add_to_global_variable_list = { name = light_spells target = flag:judgement }
    add_to_global_variable_list = { name = light_spells target = flag:exorcism }
    add_to_global_variable_list = { name = light_spells target = flag:expulsion }
    add_to_global_variable_list = { name = light_spells target = flag:avenging_wrath }
    add_to_global_variable_list = { name = light_spells target = flag:salvation }
    add_to_global_variable_list = { name = light_spells target = flag:bless }
    add_to_global_variable_list = { name = light_spells target = flag:divine_shield }
    add_to_global_variable_list = { name = light_spells target = flag:consecration }
    add_to_global_variable_list = { name = light_spells target = flag:rebuke }
    add_to_global_variable_list = { name = light_spells target = flag:divine_storm }
    add_to_global_variable_list = { name = light_spells target = flag:blessed_bastion }
}

cast_flash_of_light_effect = { # Refer to Dispel sheet
    if = {
        limit = { exists = var:flash_of_light_recipient }
        var:flash_of_light_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:flash_of_light
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    if = {
        limit = {
            exists = scope:this_recipient
        }
        # Look at ranks first
        if = {
            limit = {
                OR = { # current_spell_rank is for tooltips
                    AND = {
                        exists = var:flash_of_light_rank
                        var:flash_of_light_rank = 3
                    }
                    AND = {
                        exists = var:current_spell_rank
                        var:current_spell_rank = 3
                    }
                }
            }
            scope:this_recipient = {
                if = {
                    limit = {
                        target_has_magic_illness_trigger = yes
                    }
                    remove_magic_illness_effect =  yes
                }
                else_if = {
                    limit = {
                        target_has_major_illness_trigger = yes
                    }
                    remove_major_illness_effect = yes
                }
                else = {
                    custom_tooltip = wc_dispel_no_effect_tooltip
                }
            }
        }
        else_if = {
            limit = {
                OR = {
                    AND = {
                        exists = var:flash_of_light_rank
                        var:flash_of_light_rank = 2
                    }
                    AND = {
                        exists = var:current_spell_rank
                        var:current_spell_rank = 2
                    }
                }
            }
            scope:this_recipient = {
                if = {
                    limit = {
                        target_has_magic_injury_trigger = yes
                    }
                    remove_magic_injury_effect = { REDUCE_SEVERITY = yes }
                }
                else_if = {
                    limit = {
                        target_has_illness_trigger = yes
                    }
                    remove_illness_effect = yes
                }
                else = {
                    custom_tooltip = wc_dispel_no_effect_tooltip
                }
            }
        }
        else_if = {
            limit = {
                OR = {
                    AND = {
                        exists = var:flash_of_light_rank
                        var:flash_of_light_rank = 1
                    }
                    AND = {
                        exists = var:current_spell_rank
                        var:current_spell_rank = 1
                    }
                }
            }
            scope:this_recipient = {
                if = {
                    limit = {
                        target_has_injury_trigger = yes
                    }
                    remove_injury_effect = { REDUCE_SEVERITY = yes }
                }
                else = {
                    custom_tooltip = wc_dispel_no_effect_tooltip
                }
            }
        }

    }

}

cast_dispel_effect = {
    if = {
        limit = { exists = var:dispel_recipient }
        var:dispel_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:dispel
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        custom_tooltip = wc_dispel_effect
        every_spell_modifier_effect = { EFFECT = dispel_add_modifier_to_list_effect }
        if = {
            limit = {
                has_variable_list = dispel_modifiers
            }
            random_in_list = {
                variable = dispel_modifiers
                save_scope_as = dispel_modifier
            }
            every_spell_modifier_effect = { EFFECT = dispel_remove_modifier_effect }
            clear_variable_list = dispel_modifiers
        }
        add_character_flag = {
            flag = wc_recently_dispelled_flag
            days = 180
        }
    }
}

dispel_add_modifier_to_list_effect = {
    if = {
        limit = {
            has_character_modifier = $MODIFIER$_modifier
            flag:$TYPE$ = flag:negative
        }
        add_to_variable_list = {
            name = dispel_modifiers
            target = flag:$MODIFIER$
        }
    }
    if = { # Error prevention
        limit = { flag:$SPELL$ = flag:error }
    }
}

dispel_remove_modifier_effect = {
    if = {
        limit = {
            exists = scope:dispel_modifier
            flag:$MODIFIER$ = scope:dispel_modifier
        }
        send_interface_toast = {
            title = wc_dispel_successful
            left_icon = scope:this_recipient
            right_icon = root
            remove_character_modifier = $MODIFIER$_modifier
        }
        if = {
            limit = {
                NOT = {
                    scope:this_recipient ?= root
                }
            }
            hidden_effect = {
                send_interface_toast = {
                    title = wc_dispel_successful
                    left_icon = scope:this_recipient
                    right_icon = root
                    show_as_tooltip = {
                        scope:this_recipient = {
                            remove_character_modifier = $MODIFIER$_modifier
                        }
                    }
                }
            }
        }
    }

    if = { # Error prevention
        limit = { flag:$TYPE$ = flag:error }
        limit = { flag:$SPELL$ = flag:error }
    }
}

cast_lightwell_effect = {
    if = {
        limit = { exists = var:lightwell_recipient }
        var:lightwell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:lightwell
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    if = {
        limit = {
            exists = scope:this_recipient
        }
        scope:this_recipient = {
            root = {
                save_temporary_scope_value_as = {
                    name = duration
                    value = wc_spell_lightwell_duration_days_value
                }
            }
            add_character_modifier = {
                modifier = wc_lightwell_modifier
                days = wc_current_spell_duration
            }
        }
    }
}

cast_holy_fire_effect = {
    if = {
        limit = { exists = var:holy_fire_recipient }
        var:holy_fire_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:holy_fire
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_holy_fire_duration_days_value
            }
        }
        random_list = {
            80 = {
                scope:this_recipient = {
                    add_character_modifier = {
                        modifier = wc_holy_fire_modifier
                        days = wc_current_spell_duration
                    }
                    save_temporary_scope_as = dodger
                }
                hidden_effect = {
                    root = {
                        send_interface_toast = {
                            title = wc_spell_hit
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_holy_fire_hit_tt
                        }
                    }
                }
            }
            20 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                custom_tooltip = wc_holy_fire_resist_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger}
                    root = {
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_holy_fire_dodge
                        }
                    }
                }
            }
        }
    }
}

cast_judgement_effect = {
    if = {
        limit = { exists = var:judgement_recipient }
        var:judgement_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:judgement
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        random_list = {
            80 = {
                custom_tooltip = wc_judgement_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }
                    every_secret = {
                        expose_secret = root
                    }
                    root = {
                        send_interface_toast = {
                            title = wc_spell_hit
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_judgement_hit_tt
                        }
                    }
                }
            }
            20 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                custom_tooltip = wc_judgement_resist_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }
                    root = {
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_judgement_dodge
                        }
                    }
                }
            }
        }
    }
}

cast_expulsion_effect = {
    if = {
        limit = { exists = var:expulsion_recipient }
        var:expulsion_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:expulsion
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    scope:this_recipient ?= {
        if = {
            limit = {
                target_has_psych_illness_trigger = yes
            }
            remove_psych_illness_effect = yes
        }
    }
}

cast_exorcism_effect = {
    if = {
        limit = { exists = var:exorcism_recipient }
        var:exorcism_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:exorcism
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    save_temporary_scope_value_as = {
        name = duration
        value = wc_spell_exorcism_duration_days_value
    }
    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        excorism_effect = yes
    }
    if = {
        limit = { has_variable_list = exorcism_targets_list }
        every_in_list = {
            variable = exorcism_targets_list
            save_scope_as = this_recipient
            save_scope_value_as = {
                name = spell_dodge_chance
                value = wc_light_magic_resistance_dodge_value
            }
            excorism_effect = yes
        }
    }
    else_if = {
        limit = { has_variable_list = spell_targets_list }
        every_in_list = {
            variable = spell_targets_list
            save_scope_as = this_recipient
            save_scope_value_as = {
                name = spell_dodge_chance
                value = wc_light_magic_resistance_dodge_value
            }
            excorism_effect = yes
        }
    }
}
excorism_effect = {
    random_list = {
        80 = {
            add_character_modifier = {
                modifier = wc_exorcism_modifier
                days = wc_current_spell_duration
            }
            if = {
                limit = {
                    OR = {
                        culture = { has_same_culture_heritage = culture:eredruin }
                        culture = { has_same_culture_heritage = culture:scourge }
                        has_trait = being_void
                        has_trait = being_demon
                        has_trait = being_undead
                    }
                }
                add_or_increase_burned_effect = yes
            }
            if = { # counting stacks
                limit = {
                    has_variable = exorcism
                }
                set_variable = {
                    name = exorcism_2
                    value = 1
                    days = wc_current_spell_duration
                }
            }
            else_if = {
                limit = {
                    has_variable = exorcism_2
                }
                set_variable = {
                    name = exorcism_3
                    value = 1
                    days = wc_current_spell_duration
                }
            }
            else = {
                set_variable = {
                    name = exorcism
                    value = 1
                    days = wc_current_spell_duration
                }
            }
            hidden_effect = {
                root = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }
                    send_interface_toast = {
                        title = wc_spell_hit
                        left_icon = scope:this_recipient
                        right_icon = root
                        custom_tooltip = wc_exorcism_hit_tt
                    }
                }
            }
        }
        20 = {
            modifier = {
                is_alive = yes
                add = scope:spell_dodge_chance
            }
            custom_tooltip = wc_exorcism_resist_tt
            hidden_effect = {
                root = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }
                    send_interface_toast = {
                        title = wc_spell_dodged
                        left_icon = scope:this_recipient
                        right_icon = root
                        custom_tooltip = wc_exorcism_dodge
                    }
                }
            }
        }
    }
}
cast_avenging_wrath_effect = {
    if = {
        limit = { exists = var:avenging_wrath_recipient }
        var:avenging_wrath_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:avenging_wrath
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        random_list = {
            70 = {
                scope:this_recipient = {
                    add_trait = holy_wrath
                    save_temporary_scope_as = dodger
                }
                if = {
                    limit = {
                        NOT = { this = root }
                    }
                    add_opinion = {
                        modifier = wc_wrathed_me
                        target = root
                    }
                }
                hidden_effect = {
                    root = {
                        send_interface_toast = {
                            title = wc_spell_hit
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_avenging_wrath_hit_tt
                        }
                        if = {
                            limit = {
                                has_perk = light_magic_tree_2_perk_8
                            }
                            random_list = {
                                70 = { 
                                    # nothing
                                }
                                30 = {
                                    trigger = {
                                        scope:this_recipient = { NOT = { has_trait = incapable } }
                                    }
                                    modifier = {
                                        add = 20
                                        scope:this_recipient = { has_trait = being_undead }
                                    }
                                    modifier = {
                                        add = 20
                                        scope:this_recipient = { has_trait = being_demon }
                                    }
                                    modifier = {
                                        add = 20
                                        scope:this_recipient = { has_trait = being_void }
                                    }
                                    send_interface_toast = {
                                        title = holy_retribution_title
                                        left_icon = scope:this_recipient
                                        right_icon = root
                                        scope:this_recipient = { 
                                            add_trait = incapable
                                            trigger_event = {
                                                id = wc_magic_spell_events.4010
                                                days = { 90 180 }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            30 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                modifier = {
                    add = -10
                    root = { has_perk = light_magic_tree_2_perk_8 }
                }
                custom_tooltip = wc_avenging_wrath_resist_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }
                    root = {
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_avenging_wrath_dodge
                        }
                    }
                }
            }
        }
    }
}

cast_salvation_effect = {
    if = {
        limit = { exists = var:salvation_recipient }
        var:salvation_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:salvation
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        if = {
            limit = {
                has_trait = being_undead
            }
            remove_trait = being_undead
            root = { save_scope_as = salvation_caster }
            proc_salvation_effect = yes
        }
        else = {
            add_character_modifier = {
                modifier = wc_salvation_modifier
            }
            set_variable = {
                name = salvation_caster
                value = root
            }
        }
    }
}

proc_salvation_effect = {
    remove_character_modifier = wc_salvation_modifier
    add_character_modifier = wc_saved_with_salvation_modifier

    if = {
        limit = {
            scope:salvation_caster = {
                is_alive = yes
            }
        }
        add_opinion = {
            modifier = wc_saved_me_salvation
            target = scope:salvation_caster
        }
    }

    if = {
        limit = { exists = scope:killer }
        add_opinion = { modifier = attempted_to_kill_me target = scope:killer }
    }

    while = { # DISPEL HIM OF EVERYTHING SO HE DOESNT DIE AGIAN
        limit = {
            OR = {
                target_has_magic_illness_trigger = yes
                target_has_illness_trigger = yes
                target_has_major_illness_trigger = yes
                target_has_injury_trigger = yes
                target_has_major_injury_trigger = yes
                target_has_magic_injury_trigger = yes
            }
        }

        if = {
            limit = {
                target_has_magic_injury_trigger = yes
            }
            remove_magic_injury_effect = { REDUCE_SEVERITY = no }
        }
        else_if = {
            limit = {
                target_has_major_injury_trigger = yes
            }
            remove_major_injury_effect = yes
        }
        else_if = {
            limit = {
                target_has_magic_illness_trigger = yes
            }
            remove_magic_illness_effect = yes
        }
        else_if = {
            limit = {
                target_has_major_illness_trigger = yes
            }
            remove_major_illness_effect = yes
        }
        else_if = {
            limit = {
                target_has_illness_trigger = yes
            }
            remove_illness_effect = yes
        }
        else_if = {
            limit = {
                target_has_injury_trigger = yes
            }
            remove_injury_effect = { REDUCE_SEVERITY = no }
        }
    }
}

cast_bless_effect = {
    if = {
        limit = { exists = var:bless_recipient }
        var:bless_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:bless
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_bless_duration_days_value
            }
        }
        custom_tooltip = wc_bless_effect
        every_spell_modifier_effect = { EFFECT = bless_add_modifier_to_list_effect }
        if = {
            limit = {
                has_variable_list = bless_modifiers
            }
            random_in_list = {
                variable = bless_modifiers
                save_scope_as = bless_modifier
            }
            every_spell_modifier_effect = { EFFECT = bless_add_modifier_effect }
            clear_variable_list = bless_modifiers
        }
        add_character_flag = {
            flag = wc_recently_blessed
            years = 1
        }
    }
}

bless_add_modifier_to_list_effect = {
    if = {
        limit = {
            NOT = { has_character_modifier = $MODIFIER$_modifier }
            flag:$TYPE$ = flag:positive
            NOT = {
                flag:$SPELL$ = flag:none
            }
        }
        add_to_variable_list = {
            name = bless_modifiers
            target = flag:$MODIFIER$
        }
    }
}

bless_add_modifier_effect = {
    if = {
        limit = {
            exists = scope:bless_modifier
            flag:$MODIFIER$ = scope:bless_modifier
        }

        send_interface_toast = {
            title = wc_bless_successful
            left_icon = scope:this_recipient
            right_icon = root
            add_character_modifier = {
                modifier = $MODIFIER$_modifier
                days = wc_current_spell_duration
            }
        }
        if = {
            limit = {
                NOT = {
                    scope:this_recipient ?= root
                }
            }
            hidden_effect = {
                send_interface_toast = {
                    title = wc_bless_successful
                    left_icon = scope:this_recipient
                    right_icon = root
                    show_as_tooltip = {
                        scope:this_recipient = {
                            add_character_modifier = {
                                modifier = $MODIFIER$_modifier
                                days = wc_current_spell_duration
                            }
                        }
                    }
                }
            }
        }

    }

    if = { # Error prevention
        limit = { flag:$TYPE$ = flag:error }
        limit = { flag:$SPELL$ = flag:error }
    }
}

cast_divine_shield_effect = {
    if = {
        limit = { exists = var:divine_shield_recipient }
        var:divine_shield_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:divine_shield
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        add_character_modifier = {
            modifier = wc_divine_shield_modifier
            days = wc_spell_divine_shield_duration_days_value
        }
    }
}

cast_consecration_effect = {
    if = {
        limit = { exists = var:consecration_recipient }
        var:consecration_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:consecration
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    root = {
        set_variable = {
            name = consecration_moves_remaining
            value = 3
        }
    }

    if = {
        limit = {
            exists = scope:this_recipient
        }
        if = {
            limit = {
                OR = {
                    scope:this_recipient.holder = root
                    scope:this_recipient.holder.liege ?= root
                    scope:this_recipient.holder.top_liege ?= root
                }
            }
            apply_consecration_effect = {
                CONSECRATION_TYPE = flag:positive
                COUNTY = scope:this_recipient
            }
        }
        else = {
            apply_consecration_effect = {
                CONSECRATION_TYPE = flag:negative
                COUNTY = scope:this_recipient
            }
        }
    }
}

apply_consecration_effect = {
    clear_variable_list = consecration_neighboring_counties

    set_variable = {
        name = consecration_county
        value = $COUNTY$
    }

    save_temporary_scope_value_as = {
        name = consecration_duration
        value = wc_spell_consecration_duration_days_value
    }

    change_variable = {
        name = consecration_moves_remaining
        add = -1
    }

    if = {
        limit = {
            $CONSECRATION_TYPE$ = flag:positive
        }
        $COUNTY$ = {
            add_county_modifier = {
                modifier = wc_consecration_county_positive_modifier
                days = wc_consecration_spell_duration
            }
            set_variable = {
                name = consecration_owner
                value = root
            }
            every_neighboring_county = {
                limit = {
                    NOT = { this = $COUNTY$ }
                    exists = holder
                }
                save_scope_as = neighboring_county_consecration
                custom_tooltip = wc_consecration_neighboring_duchy_effect
                root = {
                    add_to_variable_list = {
                        name = consecration_neighboring_counties
                        target = scope:neighboring_county_consecration
                    }
                }
            }
        }
    }
    else = {
        $COUNTY$ = {
            add_county_modifier = {
                modifier = wc_consecration_county_negative_modifier
                days = wc_consecration_spell_duration
            }
            set_variable = {
                name = consecration_owner
                value = root
            }
            every_neighboring_county = {
                limit = {
                    NOT = { this = $COUNTY$ }
                    exists = holder
                }
                save_scope_as = neighboring_county_consecration
                custom_tooltip = wc_consecration_neighboring_duchy_effect
                root = {
                    add_to_variable_list = {
                        name = consecration_neighboring_counties
                        target = scope:neighboring_county_consecration
                    }
                }
            }
            holder = {
                add_opinion = { modifier = wc_casted_harmful_spell target = root opinion = -20 }
            }
        }
    }
}

move_consecration_effect = {
    clear_variable_list = consecration_neighboring_counties
    if = {
        limit = {
            var:consecration_county = {
                has_county_modifier = wc_consecration_county_positive_modifier
            }
        }
        var:consecration_county = {
            remove_county_modifier = wc_consecration_county_positive_modifier
        }
        apply_consecration_effect = {
            CONSECRATION_TYPE = flag:positive
            COUNTY = $COUNTY$
        }
    }
    else = {
        var:consecration_county = {
            remove_county_modifier = wc_consecration_county_negative_modifier
        }
        apply_consecration_effect = {
            CONSECRATION_TYPE = flag:negative
            COUNTY = $COUNTY$
        }
    }
}

cast_rebuke_effect = {
    if = {
        limit = { exists = var:rebuke_recipient }
        var:rebuke_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:rebuke
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        random_list = {
            80 = {
                add_character_modifier = {
                    modifier = wc_rebuke_modifier
                    months = 3
                }
                if = {
                    limit = {
                        has_variable_list = current_spells_casting
                        any_in_list = {
                            variable = current_spells_casting
                            limit = {
                                NOR = {
                                    spell_is_ritual_trigger = { SPELL = this }
                                    this = flag:rebuke
                                }
                            }
                        }
                    }
                    custom_tooltip = wc_rebuke_kick_tt
                    random_in_list = {
                        variable = current_spells_casting
                        limit = {
                            NOR = {
                                spell_is_ritual_trigger = { SPELL = this }
                                this = flag:rebuke
                            }
                        }
                        save_scope_as = spell_to_kick
                        hidden_effect = {
                            execute_scoped_spell_effect = {
                                EFFECT = cancel_cast_effect
                                SPELL = scope:spell_to_kick
                            }
                            execute_scoped_spell_effect = {
                                EFFECT = put_spell_on_cooldown_effect
                                SPELL = scope:spell_to_kick
                            }
                            root = {
                                save_temporary_scope_as = rebuker
                                scope:this_recipient = { save_temporary_scope_as = dodger }
                                send_interface_toast = {
                                    title = wc_spell_hit
                                    left_icon = scope:this_recipient
                                    right_icon = root
                                    custom_tooltip = wc_rebuke_hit_tt
                                }
                            }
                            send_interface_toast = {
                                title = wc_spell_hit
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_rebuke_kicked_you
                            }
                        }
                    }
                }

            }
            20 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                custom_tooltip = wc_rebuke_resist_tt
                hidden_effect = {
                    root = {
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_rebuke_dodge
                        }
                    }
                }
            }
        }
    }
}

cast_divine_storm_effect = {
    if = {
        limit = { exists = var:divine_storm_recipient }
        var:divine_storm_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:divine_storm
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    root = {
        random_list = {
            40 = {
                add_or_increase_burned_effect = yes
            }
            40 = {
                if = {
                    limit = {
                        NOT = { has_trait = wounded_1 }
                    }
                    add_trait = wounded_1
                }
                else = {
                    change_trait_rank = { trait = wounded rank = 1 max = 3 }
                }
            }
            20 = {
                add_trait = holy_wrath
            }
        }
    }

    scope:this_recipient ?= {
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_divine_storm_duration_days_value
            }
        }
        change_county_control = -100
        change_development_level = -10
        custom_tooltip = wc_divine_storm_tt
        every_in_de_jure_hierarchy = {
            if = {
                limit = {
                    tier = tier_county
                }
                add_county_modifier = {
                    modifier = wc_divine_storm_county_modifier
                    days = wc_current_spell_duration
                }
                trigger_event = {
                    on_action = wc_divine_storm_county_pulse
                    months = 1
                }
            }
            else_if = {
                limit = {
                    tier = tier_barony
                }
                title_province = {
                    hidden_effect = {
                        every_character_in_location = {
                            limit = {
                                NOT = {
                                    has_character_modifier = wc_divine_storm_character_modifier
                                }
                            }
                            apply_character_divine_storm_effect = yes
                        }
                    }
                }
            }
        }
    }
}
apply_character_divine_storm_effect = {
    if = {
        limit = {
            NOT = {
                has_character_modifier = wc_divine_storm_character_modifier
            }
        }
        if = {
            limit = {
                OR = {
                    culture = { has_same_culture_heritage = culture:eredruin }
                    culture = { has_same_culture_heritage = culture:scourge }
                    has_trait = being_void
                    has_trait = being_demon
                    has_trait = being_undead
                }
            }
            random_list = {
                40 = {
                    add_or_increase_burned_effect = yes
                }
                40 = {
                    if = {
                        limit = {
                            NOT = { has_trait = wounded_1 }
                        }
                        add_trait = wounded_1
                    }
                    else = {
                        change_trait_rank = { trait = wounded rank = 1 max = 3 }
                    }
                }
                20 = {
                    add_trait = holy_wrath
                }
            }
        }
        add_character_modifier = {
            modifier = wc_divine_storm_character_modifier
            days = wc_current_spell_duration
        }

        trigger_event = {
            on_action = wc_divine_storm_removal_pulse
            months = 1
        }
    }
}

cast_blessed_bastion_effect = {
    root = {
        add_character_modifier = {
            modifier = wc_blessed_bastion_modifier
            days = wc_spell_blessed_bastion_duration_days_value
        }
    }
    if = {
        limit = { has_variable_list = blessed_bastion_targets_list }
        blessed_bastion_effect = { LIST = blessed_bastion_targets_list }
    }
    else_if = {
        limit = { has_variable_list = spell_targets_list }
        blessed_bastion_effect = { LIST = spell_targets_list }
    }
}

blessed_bastion_effect = {
    every_in_list = {
        variable = $LIST$
        save_scope_as = this_recipient
        every_de_jure_county = {
            add_county_modifier = {
                modifier = wc_blessed_bastion_county_modifier
                days = wc_spell_blessed_bastion_duration_days_value
            }
        }
    }
}

final_stand_effect = {
    add_character_modifier = {
        modifier = important_lore_character
        years = 1
    }
    add_piety = 1000
    add_prestige = 1000
    add_legitimacy = 300
    faith = {
        change_fervor = {
            value = 3
            desc = fervor_gain_final_stand
        }
    }
}