namespace = lordaeron 

##############################################
# 1001 - 1099: Reclamation of Lordaeron Events
##############################################

lordaeron.1001 = { 

	type = character_event
	title = lordaeron.1001.title
	desc = lordaeron.1001.desc
	theme = stewardship
	override_background = market

	immediate = { 
		title:b_lordaeron.title_province = { 
			remove_building = ruined_palace_01
			add_special_building = ruined_palace_02 
		}
		title:c_lordaeron = {
			set_county_culture = culture:forsaken
		}
	}

	right_portrait = { 
		character = root
		animation = steward
	}

	trigger = {
		title:b_lordaeron = { 
			holder = { 	
				OR = {
					AND = { 	# make sure i have the title...
						is_of_forsaken_like_culture = yes 	
						this = root
					}
					AND = { 	# or that I gave out the title to someome...
						self_or_liege_is_of_forsaken_like_culture = yes 
						any_liege_or_above = {this = root }
					}
				}
			} 
			var:develop_the_undercity ?= yes
		}
	}

	#TODO: use a story cycle to handle complex fails such as sylvanas_character deaths
	on_trigger_fail = { 
		title:b_lordaeron.holder = { 
			if = { 
				limit = { self_or_liege_is_of_forsaken_like_culture = yes } 
				trigger_event = lordaeron.1001
			}
			else = { 
				trigger_event = lordaeron.1002
			}	
		}
	}

	option = { 
		name = lordaeron.1001.opt.a

		show_as_tooltip = { 
			custom_tooltip = lordaeron.1001.tooltip.a
		}

		hidden_effect = { 
			global_var:sylvanas_character = { 
				trigger_event = { 
					id = lordaeron.1101 
					years = 2
					delayed = yes
				}
			}

			every_vassal_or_below = {
				limit = { 
					faith.religion = { is_in_family = rf_shadow }
					NOT = { government_has_flag = government_is_theocracy }
				}
				add_to_temporary_list = tmp_courts
			}
			while = { 
				count = 3 # in three different courts...
				random_in_list = { 
					list = tmp_courts
					every_courtier_or_guest = {
						limit = {
							NAND = { 
								has_council_position = councillor_court_chaplain
								NOR = { 
									faith = faith:forgotten_shadow 
									piety_level >= 2 
									exists = secret_faith 
								}
								NOR = { has_trait = zealous has_trait = loyal has_trait = holy_warrior has_trait = stubborn }
							}
						}
						add_to_temporary_list = tmp_potential_cryptos
					}
					remove_from_list = tmp_courts
				}
			} 
			
			while = { 
				count = 4 # ...four different people will convert to forgotten shadow
				random_in_list = { 
					list = tmp_potential_cryptos
					make_character_crypto_religionist_effect = { CRYPTO_RELIGION = faith:forgotten_shadow }
					remove_from_list = tmp_potential_cryptos
				}
			}
			#total: 12 characters will adopt Forgotten Shadow secretly
			#TODO: Link the random vassals to the next event? could be cool to have secret faith characters randomly dispersed tho
		}
	}

}

# Failed construction of Undercity
lordaeron.1002 = { 

	type = character_event
	title = lordaeron.1002.title
	desc = lordaeron.1002.desc
	theme = dungeon
	override_background = market

	right_portrait = { 
		character = root
		animation = stress
	}

	immediate = { 
		title:b_lordaeron = {
			title_province = {
				remove_province_modifier = wc_building_undercity
			}
			set_variable = { 
				name = develop_the_undercity
				value = no
				years = 5
			}
		}
		
	}

	option = { 
		name = lordaeron.1002.opt.a
		show_as_tooltip = { 
			custom_tooltip = lordaeron.1002.tooltip.a
		}
	}
	
}

#####################################
#1100 - 1199: Post-Reclamation events
#####################################

#1100 - 1109: Selenite Revival

#lordaeron.1100 = { } Selenite Revival Redirect event in case Lordaeron changes hands

lordaeron.1101 = { 

	type = character_event
	title = lordaeron.1101.title
	desc = lordaeron.1101.desc
	theme = faith
	override_background = wc_undercity_throne_room

	immediate = {
		every_vassal_or_below = {
			limit = {
				AND = { 
					faith.religion = { is_in_family = rf_shadow }
					highest_held_title_tier >= tier_county
					NOR = { 
						faith = faith:forgotten_shadow 
						government_has_flag = government_is_theocracy 
						piety_level >= 2 
					}
					NOR = { has_trait = zealous has_trait = loyal has_trait = holy_warrior has_trait = stubborn }
				}
			}
			add_to_temporary_list = tmp_selinites
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_1 
			scope:selinite_1 = { remove_from_list = tmp_selinites }
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_2
			scope:selinite_2 = { remove_from_list = tmp_selinites }
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_3 
			scope:selinite_3 = { remove_from_list = tmp_selinites }
		}
	}

	right_portrait = { 
		character = root
		animation = worry
	}

	lower_left_portrait = {
		character = scope:selinite_1
	}

	lower_center_portrait = { 
		character = scope:selinite_2
	}

	lower_right_portrait = { 
		character = scope:selinite_3
	}

	trigger = {
		self_or_liege_is_of_forsaken_like_culture = yes
	}

	option = { 
		# retain sylvanas cult of personality - AI chance 75
		name = lordaeron.1101.opt.a
		title:c_lordaeron = { 
			set_county_faith = faith:forsaken_cult
		}
		add_character_modifier = { 
			modifier = wc_forsaken_subsumed_selinite_modifier
		}
		custom_tooltip = { 
			text = damned_will_convert_to_forsaken_cult
			trigger_event = { 
				id = lordaeron.1102
			}
		}
		ai_chance = { 
			base = 75
			ai_value_modifier = {
				ai_honor = -0.5
				ai_compassion = -1
				ai_boldness = 1
				ai_rationality = 1
			}
		}
	}

	option = { 
		# convert and delegate religious authority to cult of forgotten shadow - AI chance 20
		name = lordaeron.1101.opt.b

		trigger = { NOT = { any_held_title = { is_head_of_faith = yes } } }

		set_character_faith = faith:forgotten_shadow
		title:c_lordaeron = { 
			set_county_faith = faith:forgotten_shadow
		} 

		custom_tooltip = { 
			text = cultists_will_convert_to_forgotten_shadow
			trigger_event = { 
				id = lordaeron.1103
			}
		}

		add_character_modifier = { 
			modifier = wc_forsaken_embraced_selinite_modifier
		}
		ai_chance = { 
			base = 20
			ai_value_modifier = {
				ai_honor = -0.5
				ai_boldness = 1
				ai_zeal = -1
			}
		}
	}

	option = { 
		# retain cult of personality but grant religious freedom to selinites - AI chance 5
		name = lordaeron.1101.opt.c
		#vassal_contract_set_obligation_level = { type = religious_rights level = 1 } wanted to do this but necro govt blocks it
		random_list = { 
			55 = { 
				modifier = { add = 5    has_trait = zealous}
				modifier = { add = 5    piety_level >= 3 } 
				modifier = { add = 5    piety_level >= 4 }
				modifier = { add = 5    learning > decent_skill_rating }
				modifier = { add = 5    dread > 20 }
				modifier = { add = 5    dread > 40 } 
				modifier = { add = 5    dread > 60 } 
				modifier = { add = -15  dread > 80 } 
				# modifier for court chaplain piety level or intelligence?
				title:c_lordaeron = { 
					set_county_faith = faith:forsaken_cult
				}
			}
			45 = { 
				title:c_lordaeron = { 
					set_county_faith = faith:forgotten_shadow
				}
			}
		}
		add_character_modifier = { 
			modifier = wc_forsaken_tolerated_selinite_modifier
		}
		ai_chance = { 
			base = 5
			ai_value_modifier = {
				ai_honor = 0.5
				ai_compassion = 1
				ai_boldness = -1
				ai_zeal = -1
			}
		}
	}
}

lordaeron.1102 = { 
	hidden = yes 
	type = character_event

	immediate = { 

		save_scope_as = actor

		primary_title = {
			every_in_de_facto_hierarchy = {
				limit = { 
					AND = { 
						faith = faith:death_god 
						tier = tier_county  
					}
				}
				set_county_faith = faith:forsaken_cult 
			}
		}

		every_courtier_or_guest = {
			limit = { 
				OR = {
					culture = culture:scourge
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes
		}

		every_vassal_or_below = { 
			limit = { 
				OR = {
					culture = culture:scourge 
					faith = faith:death_god
				}
			}

			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes

			every_courtier_or_guest = {
				limit = { 
					OR = {
						culture = culture:scourge
						faith = faith:death_god
					}
				}
				save_temporary_scope_as = recipient
				new_faith_created_conversion_effect = yes
			}
		}
	}
}

lordaeron.1103 = { 
	hidden = yes 
	type = character_event

	immediate = { 
		save_temporary_scope_as = recipient 
		save_scope_as = actor 

		new_faith_created_conversion_effect = yes

		every_courtier_or_guest = {
			limit = { 
				OR = {
					culture = culture:forsaken 
					faith = faith:forsaken_cult
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes
		}

		every_vassal_or_below = { 
			limit = { 
				OR = {
					culture = culture:forsaken 
					faith = faith:forsaken_cult
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes

			every_courtier_or_guest = {
				limit = { 
					OR = {
						culture = culture:forsaken 
						faith = faith:forsaken_cult
						faith = faith:death_god
					}
				}
				save_temporary_scope_as = recipient
				new_faith_created_conversion_effect = yes
			}
		}
	}
}