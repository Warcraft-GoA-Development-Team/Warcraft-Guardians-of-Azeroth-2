# Use this effect to change infusions
# $MAGIC$ can be:
# 	light_void
# 	arcane_fel
# 	nature_death
#
# A possitive value for $ADD$ will shift the balance in the "positive" direction, for example towards light.
# A negative value for $ADD$ will shift things in the opposite direction, for example towards void.
add_magic_infusion_effect = {
	save_scope_value_as = {
		name = magic_type
		value = flag:$MAGIC$
	}
	save_scope_value_as = {
		name = inf_tt_value
		value = $ADD$
	}

	if = {
		limit = {
			NOT = {
				has_variable = $MAGIC$_infusion
			}
		}
		set_variable = {
			name = $MAGIC$_infusion
			value = 0
		}
	}

	change_variable = {
		name = $MAGIC$_infusion
		add = $ADD$
	}

	clamp_variable = { name = $MAGIC$_infusion max = 100 min = -100 }

	if = {
		limit = { 
			NOT = {
				has_trait = infusion_cosmic
			}
		}

		add_trait = infusion_cosmic
	}

	if = {
		limit = {
			scope:magic_type = flag:light_void
			$ADD$ > 0
		}
		custom_description = {
			text = "light_infusion_desc"
			value = $ADD$
		
			add_infusion_trait_xp_positive = { 
				MAGIC = $MAGIC$ 
				ADD = $ADD$
				TRAIT_POSITIVE = light 
				TRAIT_NEGATIVE = void 
			}
		} 
	}
	else_if = {
		limit = {
			scope:magic_type = flag:light_void
			$ADD$ < 0
		}
		custom_description = {
			text = "shadow_infusion_desc"
			value = negative_infusion_tooltip_value
		
			add_infusion_trait_xp_negative = { 
				MAGIC = $MAGIC$ 
				ADD = $ADD$
				TRAIT_POSITIVE = light 
				TRAIT_NEGATIVE = void 
			}
		} 
	}
	else_if = {
		limit = {
			scope:magic_type = flag:arcane_fel
			$ADD$ > 0
		}
		custom_description = {
			text = "arcane_infusion_desc"
			value = $ADD$
		
			add_infusion_trait_xp_positive = { 
				MAGIC = $MAGIC$ 
				ADD = $ADD$
				TRAIT_POSITIVE = arcane
				TRAIT_NEGATIVE = fel 
			}
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:arcane_fel
			$ADD$ < 0
		}
		custom_description = {
			text = "fel_infusion_desc"
			value = negative_infusion_tooltip_value
		
			add_infusion_trait_xp_negative = { 
				MAGIC = $MAGIC$ 
				ADD = $ADD$
				TRAIT_POSITIVE = arcane 
				TRAIT_NEGATIVE = fel 
			}
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:nature_death
			$ADD$ > 0
		}
		custom_description = {
			text = "nature_infusion_desc"
			value = $ADD$
		
			add_infusion_trait_xp_positive = { 
				MAGIC = $MAGIC$ 
				ADD = $ADD$
				TRAIT_POSITIVE = life
				TRAIT_NEGATIVE = death
			}
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:nature_death
			$ADD$ < 0
		}
		custom_description = {
			text = "death_infusion_desc"
			value = negative_infusion_tooltip_value
		
			add_infusion_trait_xp_negative = { 
				MAGIC = $MAGIC$ 
				ADD = $ADD$
				TRAIT_POSITIVE = life 
				TRAIT_NEGATIVE = death 
			}
		}
	}

	trigger_event = {
		on_action = wc_on_infusion_changed
	}
}

add_infusion_trait_xp_positive = { 
	if = {
		limit = {
			has_variable = $MAGIC$_infusion
		}
		if = {
			limit = {
				has_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_NEGATIVE$
					value > 0
				}
			}
			add_trait_xp = {
				trait = infusion_cosmic
				track = $TRAIT_NEGATIVE$
				value = {
					value = $ADD$
					multiply = -1
				}
			}
			if = {
				limit = {
					var:$MAGIC$_infusion > 0
				}

				add_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_POSITIVE$
					value = {
						value = var:$MAGIC$_infusion
					}
				}
			}
		}
		else = {
			if = {
				limit = {
					NOT = {
						has_trait_xp = {
							trait = infusion_cosmic
							track = $TRAIT_POSITIVE$
							value > 0
						}
						has_trait_xp = {
							trait = infusion_cosmic
							track = $TRAIT_NEGATIVE$
							value > 0
						}
					}
				}
				
				add_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_POSITIVE$
					value = {
						value = var:$MAGIC$_infusion
					}
				}
			}
			else = {
				add_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_POSITIVE$
					value = {
						value = $ADD$
					}
				}
			}
		}
	}
}

add_infusion_trait_xp_negative = {			
	if = {
		limit = {
			has_variable = $MAGIC$_infusion
		}
		if = {
			limit = {
				has_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_POSITIVE$
					value > 0
				}
			}
			add_trait_xp = {
				trait = infusion_cosmic
				track = $TRAIT_POSITIVE$
				value = {
					value = $ADD$
				}
			}
			if = {
				limit = {
					var:$MAGIC$_infusion < 0
				}
				
				add_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_NEGATIVE$
					value = {
						value = var:$MAGIC$_infusion
						multiply = -1
					}
				}
			}
		}
		else = {
			if = {
				limit = {
					NOT = {
						has_trait_xp = {
							trait = infusion_cosmic
							track = $TRAIT_POSITIVE$
							value > 0
						}
						has_trait_xp = {
							trait = infusion_cosmic
							track = $TRAIT_NEGATIVE$
							value > 0
						}
					}
				}
				
				add_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_NEGATIVE$
					value = {
						value = var:$MAGIC$_infusion
						multiply = -1
					}
				}
			}
			else = {
				add_trait_xp = {
					trait = infusion_cosmic
					track = $TRAIT_NEGATIVE$
					value = {
						value = $ADD$
						multiply = -1
					}
				}
			}
		}
	}
}

infusion_traits_effect = {
	if = {
		limit = {
			has_infusion_level_trigger =  { MAGIC = light_void AMOUNT = 3 }
			scope:magic_type = flag:light_void
		}
		trigger_event = WCINF.0001
	}
	else_if = {
		limit = {
			has_infusion_level_trigger =  { MAGIC = arcane_fel AMOUNT = 3 }
			scope:magic_type = flag:arcane_fel
		}
		trigger_event = WCINF.0003
	}
	else_if = {
		limit = {
			has_infusion_level_trigger =  { MAGIC = nature_death AMOUNT = 3 }
			scope:magic_type = flag:nature_death
		}
		trigger_event = WCINF.0005
	}
	if = {
		limit = {
			has_infusion_level_trigger =  { MAGIC = light_void AMOUNT = -3 }
			scope:magic_type = flag:light_void
		}
		trigger_event = WCINF.0002
	}
	else_if = {
		limit = {
			has_infusion_level_trigger =  { MAGIC = nature_death AMOUNT = -3 }
			scope:magic_type = flag:nature_death
		}
		trigger_event = WCINF.0006
	}
	
	if = {
		limit = {
			light_void_infusion_level_value < 2
			scope:magic_type = flag:light_void
			has_trait = being_light
		}
		trigger_event = WCINF.5001
	}
	else_if = {
		limit = {
			arcane_fel_infusion_level_value < 2
			scope:magic_type = flag:arcane_fel
			has_trait = being_order
		}
		trigger_event = WCINF.5003
	}
	else_if = {
		limit = {
			nature_death_infusion_level_value < 2
			scope:magic_type = flag:nature_death
			has_trait = being_life
		}
		trigger_event = WCINF.5005
	}

	if = {
		limit = {
			light_void_infusion_level_value > -2
			scope:magic_type = flag:light_void
			has_trait = being_void
		}
		trigger_event = WCINF.5002
	}
	else_if = {
		limit = {
			arcane_fel_infusion_level_value > -2
			scope:magic_type = flag:arcane_fel
			has_trait = being_demon
		}
		trigger_event = WCINF.5004
	}
	else_if = {
		limit = {
			nature_death_infusion_level_value > -2
			scope:magic_type = flag:nature_death
			has_trait = being_undead
		}
		trigger_event = WCINF.5006
	}
}

infusion_trait_duel_effect = {
	duel = {
		skill = $SKILL$
		value = 13
		
		10 = {
			desc = WCINF.$EVENT$.challenge.success
			compare_modifier = {
				value = scope:duel_value
				multiplier = 6
			}
			
			#trigger_event = WCINF.1001
			
			if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion > 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = -50 }
			}
			else_if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion < 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = 50 }
			}
		}
		
		15 = {
			desc = WCINF.$EVENT$.challenge.bad_success
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3
			}
			
			#trigger_event = WCINF.1001
			add_trait = lunatic_1
			
			stress_impact = {
				base = miniscule_stress_impact_gain
			}
			
			if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion > 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = -25 }
			}
			else_if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion < 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = 25 }
			}
		}
		
		25 = {
			desc = WCINF.$EVENT$.challenge.fail
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3
			}
			
			#trigger_event = WCINF.2001
			add_trait = $TRAIT$
			
			stress_impact = {
				base = minor_stress_impact_gain
			}
		}
		
		30 = {
			desc = WCINF.$EVENT$.challenge.bad_fail
			compare_modifier = {
				value = scope:duel_value
				multiplier = -6
			}
			
			#trigger_event = WCINF.2001
			add_trait = $TRAIT$
			add_trait = lunatic_1
			
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
}

add_collected_souls_effect = {
	if = {
		limit = {
			NOT = {
				has_variable = demon_sacrifices_needed
			}
		}
		set_variable = {
			name = demon_sacrifices_needed
			value = 0
		}
	}
	
	if = {
		limit = {
			NOT = {
				has_variable = collected_souls
			}
		}
		set_variable = {
			name = collected_souls
			value = 0
		}
	}
	
	if = {
		limit = {
			var:collected_souls < 0
		}
		
		set_variable = {
			name = collected_souls
			value = 0
		}
	}
	
	if = {
		limit = {
			OR = {
				$AMOUNT$ = 1
				$AMOUNT$ = -1
			}
		}
		custom_description = {
			text = ADD_SOUL
			value = $AMOUNT$
		}
	}
	else_if = {
		limit = {
			OR = {
				$AMOUNT$ > 0
				$AMOUNT$ < 0
			}
		}
		custom_description = {
			text = ADD_SOULS
			value = $AMOUNT$
		}
	}
	else = {
		custom_description = {
			text = ADD_SOUL
			value = $AMOUNT$
		}
	}
	change_variable = {
		name = collected_souls
		add = $AMOUNT$
	}
	
	if = {
		limit = {
			has_character_flag = demon_ritual
			var:collected_souls >= var:demon_sacrifices_needed
		}
		
		trigger_event = WCINF.4004
	}
}

demon_ritual_sacrifice_tooltip_effect = {
	custom_description = {
		text = demon_ritual_sacrifice_tooltip_effect
		value = $SACRIFICES$
	}
}

infusion_racial_traits_effect = { 
	if = {
		limit = {
			has_trait = creature_draenei
			has_infusion_level_trigger =  { MAGIC = arcane_fel AMOUNT = -3 }
		}

		remove_trait = creature_draenei
		add_trait = creature_manari
		add_character_flag = race_change_manari

		if = {
			limit = { 
				has_character_flag = race_change_draenei
			}
			remove_character_flag = race_change_draenei
		}
	}
	if = {
		limit = {
			has_trait = creature_manari
			NOT = {
				has_infusion_level_trigger =  { MAGIC = arcane_fel AMOUNT = -1 }
			}
		}

		remove_trait = creature_manari
		add_trait = creature_draenei
		add_character_flag = race_change_draenei

		if = {
			limit = { 
				has_character_flag = race_change_manari
			}
			remove_character_flag = race_change_manari
		}
	}
}

assign_infusions_from_genes_effect = { 
	if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_void_3_gfx
				}
				has_character_flag = infusion_void_3_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = light_void ADD = -100 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_void_2_gfx
				}
				has_character_flag = infusion_void_2_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = light_void ADD = -66 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_void_1_gfx
				}
				has_character_flag = infusion_void_1_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = light_void ADD = -33 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_light_3_gfx
				}
				has_character_flag = infusion_light_3_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = light_void ADD = 100 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_light_2_gfx
				}
				has_character_flag = infusion_light_2_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = light_void ADD = 66 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_light_1_gfx
				}
				has_character_flag = infusion_light_1_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = light_void ADD = 33 }
	}

	if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_fel_3_gfx
				}
				has_character_flag = infusion_fel_3_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -100 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_fel_2_gfx
				}
				has_character_flag = infusion_fel_2_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -66 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_fel_1_gfx
				}
				has_character_flag = infusion_fel_1_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_arcane_3_gfx
				}
				has_character_flag = infusion_arcane_3_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = arcane_fel ADD = 100 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_arcane_2_gfx
				}
				has_character_flag = infusion_arcane_2_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = arcane_fel ADD = 66 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_arcane_1_gfx
				}
				has_character_flag = infusion_arcane_1_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = arcane_fel ADD = 33 }
	}

	if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_death_3_gfx
				}
				has_character_flag = infusion_death_3_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = nature_death ADD = -100 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_death_2_gfx
				}
				has_character_flag = infusion_death_2_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = nature_death ADD = -66 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_death_1_gfx
				}
				has_character_flag = infusion_death_1_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = nature_death ADD = -33 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_life_3_gfx
				}
				has_character_flag = infusion_life_3_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = nature_death ADD = 100 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_life_2_gfx
				}
				has_character_flag = infusion_life_2_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = nature_death ADD = 66 }
	}
	else_if = {
		limit = { 
			OR = {
				culture = { 
					has_clothing_gfx = infusion_life_1_gfx
				}
				has_character_flag = infusion_life_1_dna
			}
		}

		add_magic_infusion_effect = { MAGIC = nature_death ADD = 33 }
	}
}

assign_racial_infusions = {
	if = {
		limit = {
			NOT = {
				has_character_flag = assigned_racial_infusions
			}
		}

		add_character_flag = assigned_racial_infusions

		if = {
			limit = { 
				OR = { 
					always = $ON_START$
					NOR = {
						AND = {
							exists = father
							father = {
								has_trait = infusion_cosmic
							}
						}
						AND = { 
							exists = mother
							mother = { 
								has_trait = infusion_cosmic
							}
						}
					}
				}
			}

			assign_infusions_from_genes_effect = yes
			# Add new races below this point
			assign_orc_infusion = yes
		}

		if = {
			limit = { 
				has_trait = being_undead
			}
			add_magic_infusion_effect = { MAGIC = nature_death ADD = -200 }
		}
		else_if = {
			limit = { 
				has_trait = being_demon
			}
			add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -200 }
		}
		else_if = {
			limit = { 
				has_trait = being_void
			}
			add_magic_infusion_effect = { MAGIC = light_void ADD = -200 }
		}
		else_if = {
			limit = { 
				has_trait = being_life
			}
			add_magic_infusion_effect = { MAGIC = nature_death ADD = 200 }
		}
		else_if = {
			limit = { 
				has_trait = being_order
			}
			add_magic_infusion_effect = { MAGIC = arcane_fel ADD = 200 }
		}
		else_if = {
			limit = { 
				has_trait = being_light
			}
			add_magic_infusion_effect = { MAGIC = light_void ADD = 200 }
		}
	}
}

assign_orc_infusion = {
	if = { 
		limit = { 
			is_ai = yes 
			is_race_no_gene_trigger = { RACE = creature_orc }
			NOR = { 
				has_infusion_dna_flag = yes
				has_character_modifier = important_lore_character
				has_variable = give_me_important_lore_character
				has_character_flag = assigned_specific_race_infusions
			}
		}

		add_character_flag = assigned_specific_race_infusions

		if = { 
			limit = { 
				culture = { 
					has_clothing_gfx = 90_orc_fel_gfx
				}
			}

			random_list = {
				90 = { 
					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 }
					add_character_flag = fel_corrupted_orc
				}
				10 = {}
			}
		}
		else_if = { 
			limit = { 
				culture = { 
					has_clothing_gfx = 80_orc_fel_gfx
				}
			}

			random_list = {
				80 = { 
					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 }
					add_character_flag = fel_corrupted_orc
				}
				20 = {}
			}
		}
		else_if = { 
			limit = { 
				culture = { 
					has_clothing_gfx = 70_orc_fel_gfx
				}
			}

			random_list = {
				70 = { 
					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 }
					add_character_flag = fel_corrupted_orc
				}
				30 = {}
			}
		}
		else_if = { 
			limit = { 
				culture = { 
					has_clothing_gfx = 5_orc_fel_gfx
				}
			}

			random_list = {
				5 = { 
					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 }
					add_character_flag = fel_corrupted_orc
				}
				95 = {}
			}
		}
		else_if = { 
			limit = { 
				culture = { 
					has_clothing_gfx = 95_orc_fel_gfx
				}
			}

			random_list = {
				95 = { 
					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 }
					add_character_flag = fel_corrupted_orc
				}
				5 = {}
			}
		}

		if = {
			limit = { 
				has_character_flag = fel_corrupted_orc
			}
			if = {
				limit = { 
					current_date < 605.1.1 # Grommash vs Mannoroth ends bloodcurse
				}
				if = { 
					limit = { 
						OR = { # Less corrupted clans
							culture = culture:blackrock
							culture = culture:bleeding_hollow
							culture = culture:burning_blade
							culture = culture:dragonmaw
							culture = culture:shadowmoon
						}
					}

					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 } # Lvl 2 fel
				}
				else_if = { 
					limit = { 
						OR = { # More corrupted clans
							culture = culture:warsong
							culture = culture:shattered_hand
							culture = culture:thunderlord
							culture = culture:bonechewer
							culture = culture:laughing_skull
						}
					}

					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -67 } # Lvl 3 fel
				}
			}
			else_if = { 
				limit = { 
					current_date < 607.1.1 # Two years for bloodcurse to fully wear off
				}

				if = { 
					limit = { 
						OR = { 
							culture = culture:warsong
							culture = culture:shattered_hand
							culture = culture:thunderlord
							culture = culture:bonechewer
							culture = culture:laughing_skull
						}
					}

					add_magic_infusion_effect = { MAGIC = arcane_fel ADD = -33 } # Lvl 2 fel
				}
			}


			remove_character_flag = fel_corrupted_orc
		}
	}
}