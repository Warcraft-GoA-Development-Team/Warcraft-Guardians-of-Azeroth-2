init_light_spells_effect = {
    add_to_global_variable_list = { name = light_spells target = flag:flash_of_light }
    add_to_global_variable_list = { name = light_spells target = flag:dispel }
    add_to_global_variable_list = { name = light_spells target = flag:holy_fire }
    add_to_global_variable_list = { name = light_spells target = flag:lightwell }
    add_to_global_variable_list = { name = light_spells target = flag:judgement }
    add_to_global_variable_list = { name = light_spells target = flag:exorcism }
    add_to_global_variable_list = { name = light_spells target = flag:expulsion }
    add_to_global_variable_list = { name = light_spells target = flag:avenging_wrath }
    add_to_global_variable_list = { name = light_spells target = flag:salvation }
}

cast_flash_of_light_effect = { # Refer to Dispel sheet
    if = {
        limit = { exists = var:flash_of_light_recipient }
        var:flash_of_light_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:flash_of_light
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    if = {
        limit = {
            exists = scope:this_recipient
        }
        # Look at ranks first
        if = {
            limit = {
                OR = { # current_spell_rank is for tooltips
                    AND = {
                        exists = var:flash_of_light_rank
                        var:flash_of_light_rank = 3
                    }
                    AND = {
                        exists = var:current_spell_rank
                        var:current_spell_rank = 3
                    }
                }
            }
            scope:this_recipient = {
                wc_dispel_template_effect = {
                    MAGIC_ILLNESS = "yes"
                    MAJOR_ILLNESS = "yes"
                    MAGIC_INJURY = "no"
                    MAJOR_INJURY = "no"
                    POISON = "no"
                    PSYCH_ILLNESS = "no"
                    ILLNESS = "no"
                    INJURY = "no"
                    REDUCE_SEVERITY = "yes"
                }
            }
        }
        else_if = {
            limit = {
                OR = {
                    AND = {
                        exists = var:flash_of_light_rank
                        var:flash_of_light_rank = 2
                    }
                    AND = {
                        exists = var:current_spell_rank
                        var:current_spell_rank = 2
                    }
                }
            }
            scope:this_recipient = {
                wc_dispel_template_effect = {
                    MAGIC_ILLNESS = "no"
                    MAJOR_ILLNESS = "no"
                    MAGIC_INJURY = "yes"
                    MAJOR_INJURY = "no"
                    POISON = "no"
                    PSYCH_ILLNESS = "no"
                    ILLNESS = "yes"
                    INJURY = "no"
                    REDUCE_SEVERITY = "yes"
                }
            }
        }
        else_if = {
            limit = {
                OR = {
                    AND = {
                        exists = var:flash_of_light_rank
                        var:flash_of_light_rank = 1
                    }
                    AND = {
                        exists = var:current_spell_rank
                        var:current_spell_rank = 1
                    }
                }
            }
            scope:this_recipient = {
                wc_dispel_template_effect = {
                    MAGIC_ILLNESS = "no"
                    MAJOR_ILLNESS = "no"
                    MAGIC_INJURY = "no"
                    MAJOR_INJURY = "no"
                    POISON = "no"
                    PSYCH_ILLNESS = "no"
                    ILLNESS = "no"
                    INJURY = "yes"
                    REDUCE_SEVERITY = "yes"
                }
            }
        }

    }

}

cast_dispel_effect = {
    if = {
        limit = { exists = var:dispel_recipient }
        var:dispel_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:dispel
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        random_list = {
            0 = {
                modifier = { add = 1 has_character_modifier = wc_burnout_modifier }
                remove_character_modifier = wc_burnout_modifier
            }
            0 = {
                modifier = { add = 1 has_character_modifier = wc_frostbolt_modifier }
                remove_character_modifier = wc_frostbolt_modifier
            }
            0 = {
                modifier = { add = 1 has_character_modifier = wc_blizzard_character_modifier }
                remove_character_modifier = wc_blizzard_character_modifier
            }
            0 = {
                modifier = { add = 1 has_character_modifier = wc_frost_nova_modifier }
                remove_character_modifier = wc_frost_nova_modifier
            }
            0 = {
                modifier = { add = 1 has_character_modifier = wc_slow_modifier }
                remove_character_modifier = wc_slow_modifier
            }
            0 = {
                modifier = { add = 1 has_character_modifier = wc_arcane_dome_character_modifier }
                remove_character_modifier = wc_arcane_dome_character_modifier
            }
            0 = {
                modifier = { add = 1 has_character_modifier = wc_holy_fire_modifier }
                remove_character_modifier = wc_holy_fire_modifier
            }
            0 = {
                modifier = { add = 1 has_character_modifier = wc_exorcism_modifier }
                remove_character_modifier = wc_exorcism_modifier
            }
        }
        add_character_flag = {
            flag = wc_recently_dispelled_flag
            days = 180
        }
    }
}

cast_lightwell_effect = {
    if = {
        limit = { exists = var:lightwell_recipient }
        var:lightwell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:lightwell
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    if = {
        limit = {
            exists = scope:this_recipient
        }
        scope:this_recipient = {
            add_character_modifier = {
                modifier = wc_lightwell_modifier
                days = wc_spell_lightwell_duration_days_value
            }
        }
    }
}

cast_holy_fire_effect = {
    if = {
        limit = { exists = var:holy_fire_recipient }
        var:holy_fire_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:holy_fire
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        random_list = {
            80 = {
                scope:this_recipient = {
                    add_character_modifier = {
                        modifier = wc_holy_fire_modifier
                        days = wc_spell_holy_fire_duration_days_value
                    }
                    save_temporary_scope_as = dodger
                }
                hidden_effect = {
                    root = {
                        send_interface_toast = {
                            title = wc_spell_hit
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_holy_fire_hit_tt
                        }
                    }
                }
            }
            20 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                custom_tooltip = wc_holy_fire_resist_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger}
                    root = {
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_holy_fire_dodge
                        }
                    }
                }
            }
        }
    }
}

cast_judgement_effect = {
    if = {
        limit = { exists = var:judgement_recipient }
        var:judgement_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:judgement
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        random_list = {
            80 = {
                custom_tooltip = wc_judgement_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }

                    every_secret = {
                        expose_secret = root
                    }
                    root = {
                        send_interface_toast = {
                            title = wc_spell_hit
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_judgement_hit_tt
                        }
                    }
                }
            }
            20 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                custom_tooltip = wc_judgement_resist_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }
                    root = {
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_judgement_dodge
                        }
                    }
                }
            }
        }
    }
}

cast_expulsion_effect = {
    if = {
        limit = { exists = var:expulsion_recipient }
        var:expulsion_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:expulsion
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    scope:this_recipient ?= {
        wc_dispel_template_effect = {
            MAGIC_ILLNESS = "no"
            MAJOR_ILLNESS = "no"
            MAGIC_INJURY = "no"
            MAJOR_INJURY = "no"
            POISON = "no"
            PSYCH_ILLNESS = "yes"
            ILLNESS = "no"
            INJURY = "no"
            REDUCE_SEVERITY = "yes"
        }
    }
}

cast_exorcism_effect = {
    if = {
        limit = { exists = var:exorcism_recipient }
        var:exorcism_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:exorcism
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        random_list = {
            80 = {
                add_character_modifier = {
                    modifier = wc_exorcism_modifier
                    days = wc_spell_exorcism_duration_days_value
                }
                if = {
                    limit = {
                        OR = {
                            culture = { has_same_culture_heritage = culture:eredruin }
                            culture = { has_same_culture_heritage = culture:scourge }
                            has_trait = being_void
                            has_trait = being_demon
                            has_trait = being_undead
                        }
                    }
                    add_or_increase_burned_effect = yes
                }
                if = { # counting stacks
                    limit = {
                        has_variable = exorcism
                    }
                    set_variable = {
                        name = exorcism_2
                        value = 1
                        days = wc_current_spell_duration
                    }
                }
                else_if = {
                    limit = {
                        has_variable = exorcism_2
                    }
                    set_variable = {
                        name = exorcism_3
                        value = 1
                        days = wc_current_spell_duration
                    }
                }
                else = {
                    set_variable = {
                        name = exorcism
                        value = 1
                        days = wc_current_spell_duration
                    }
                }
                hidden_effect = {
                    root = {
                        scope:this_recipient = { save_temporary_scope_as = dodger }
                        send_interface_toast = {
                            title = wc_spell_hit
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_exorcism_hit_tt
                        }
                    }
                }
            }
            20 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                custom_tooltip = wc_exorcism_resist_tt
                hidden_effect = {
                    root = {
                        scope:this_recipient = { save_temporary_scope_as = dodger }
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_exorcism_dodge
                        }
                    }
                }
            }

        }
    }
}


cast_avenging_wrath_effect = {
    if = {
        limit = { exists = var:avenging_wrath_recipient }
        var:avenging_wrath_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:avenging_wrath
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        save_scope_value_as = {
            name = spell_dodge_chance
            value = wc_light_magic_resistance_dodge_value
        }
        random_list = {
            70 = {
                scope:this_recipient = {
                    add_trait = holy_wrath
                    save_temporary_scope_as = dodger
                }
                if = {
                    limit = {
                        NOT = { this = root }
                    }
                    add_opinion = {
                        modifier = wc_wrathed_me
                        target = root
                    }
                }
                hidden_effect = {
                    root = {
                        send_interface_toast = {
                            title = wc_spell_hit
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_avenging_wrath_hit_tt
                        }
                    }
                }
            }
            30 = {
                modifier = {
                    is_alive = yes
                    add = scope:spell_dodge_chance
                }
                custom_tooltip = wc_avenging_wrath_resist_tt
                hidden_effect = {
                    scope:this_recipient = { save_temporary_scope_as = dodger }
                    root = {
                        send_interface_toast = {
                            title = wc_spell_dodged
                            left_icon = scope:this_recipient
                            right_icon = root
                            custom_tooltip = wc_avenging_wrath_dodge
                        }
                    }
                }
            }
        }
    }
}

cast_salvation_effect = {
    if = {
        limit = { exists = var:salvation_recipient }
        var:salvation_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:salvation
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        add_character_modifier = {
            modifier = wc_salvation_modifier
        }
        set_variable = {
            name = salvation_caster
            value = root 
        }
    }
}   

proc_salvation_effect = {
    remove_character_modifier = wc_salvation_modifier
    add_character_modifier = wc_saved_with_salvation_modifier
}