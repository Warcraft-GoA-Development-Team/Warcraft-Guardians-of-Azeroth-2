init_order_spells_effect = {
    # Fire
    add_to_global_variable_list = { name = order_spells target = flag:scorch }
    add_to_global_variable_list = { name = order_spells target = flag:fire_shield }
    add_to_global_variable_list = { name = order_spells target = flag:pyroblast }
    add_to_global_variable_list = { name = order_spells target = flag:flamestrike }

    # Frost
    add_to_global_variable_list = { name = order_spells target = flag:frostbolt }

    # Both
    add_to_global_variable_list = { name = order_spells target = flag:frostfire_bolt }
}

cast_scorch_effect = {
    if = {
        limit = { exists = var:scorch_recipient }
        var:scorch_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:scorch
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }

    scope:this_recipient = {
        if = { # cannot do a random knight because tooltip and effect will differ.
            limit = {
                NOT = { has_trait = burned_3 }
            }
            save_scope_value_as = {
                name = spell_dodge_chance
                value = wc_order_magic_resistance_dodge_value
            }
            random_list = {
                100 = {
                    add_or_increase_burned_effect = yes
                    add_opinion = {
                        modifier = wc_burned_me
                        target = root
                    }
                    hidden_effect = {
                        root = {
                            send_interface_toast = {
                                title = wc_spell_hit
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_scorch_hit_tt
                            }
                        }
                    }
                }
                20 = {
                    custom_tooltip = wc_scorch_resist_tt
                    modifier = {
                        is_alive = yes
                        add = scope:spell_dodge_chance
                    }
                    hidden_effect = {
                        root = {
                            send_interface_toast = {
                                title = wc_spell_dodged
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_scorch_dodge
                            }
                        }
                    }
                }
            }
        }
    }
}

cast_pyroblast_effect = {
    if = {
        limit = { exists = var:pyroblast_recipient }
        var:pyroblast_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:pyroblast
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }
    if = {
        limit = {
            exists = scope:this_recipient
            OR = {
                any_war_enemy = {
                    any_army = {
                        exists = army_commander
                        army_commander = scope:this_recipient.army_commander
                    }
                }
            }
        }
        scope:this_recipient.army_commander = {
            if = {
                limit = {
                    NOT = {
                        has_trait = burned_3
                    }
                }

                save_scope_value_as = {
                    name = spell_dodge_chance
                    value = wc_order_magic_resistance_dodge_value
                }
                random_list = {
                    100 = {
                        add_or_increase_burned_effect = yes
                        add_opinion = {
                            modifier = wc_burned_me
                            target = root
                        }
                        hidden_effect = {
                            save_temporary_scope_as = dodger
                            root = {
                                send_interface_toast = {
                                    title = wc_spell_hit
                                    left_icon = prev
                                    right_icon = root
                                    custom_tooltip = wc_pyroblast_hit_tt
                                }
                            }
                        }
                    }
                    20 = {
                        custom_tooltip = wc_pyroblast_resist_tt
                        modifier = {
                            is_alive = yes
                            add = scope:spell_dodge_chance
                        }
                        hidden_effect = {
                            save_temporary_scope_as = dodger
                            root = {
                                send_interface_toast = {
                                    title = wc_spell_dodged
                                    left_icon = prev
                                    right_icon = root
                                    custom_tooltip = wc_pyroblast_dodge
                                }
                            }
                        }
                    }
                }
            }
        }

        custom_tooltip = {
            text = wc_spell_pyroblast_knights_tt
            scope:this_recipient.army_owner = {
                every_knight = {
                    limit = {
                        exists = knight_army
                        knight_army = scope:this_recipient
                    }

                    if = {
                        limit = {
                            NOT = {
                                has_trait = burned_3
                            }
                        }

                        save_scope_value_as = {
                            name = spell_dodge_chance
                            value = wc_order_magic_resistance_dodge_value
                        }
                        random_list = {
                            100 = {
                                add_or_increase_burned_effect = yes
                                add_opinion = {
                                    modifier = wc_burned_me
                                    target = root
                                }
                                hidden_effect = {
                                    save_temporary_scope_as = dodger
                                    root = {
                                        send_interface_toast = {
                                            title = wc_spell_hit
                                            left_icon = prev
                                            right_icon = root
                                            custom_tooltip = wc_pyroblast_hit_tt
                                        }
                                    }
                                }
                            }
                            20 = {
                                custom_tooltip = wc_pyroblast_resist_tt
                                modifier = {
                                    is_alive = yes
                                    add = scope:spell_dodge_chance
                                }
                                hidden_effect = {
                                    save_temporary_scope_as = dodger
                                    root = {
                                        send_interface_toast = {
                                            title = wc_spell_dodged
                                            left_icon = prev
                                            right_icon = root
                                            custom_tooltip = wc_pyroblast_dodge
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

cast_flamestrike_effect = {
    if = {
        limit = { exists = var:flamestrike_recipient }
        var:flamestrike_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:flamestrike
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    if = {
        limit = {
            exists = scope:this_recipient
        }
        scope:this_recipient = {
            hidden_effect = {
                root = {
                    send_interface_toast = {
                        title = wc_spell_hit
                        left_icon = scope:this_recipient.holder
                        right_icon = root
                        custom_tooltip = wc_flamestrike_hit_tt
                    }
                }
            }

            custom_tooltip = {
                text = wc_spell_flamestrike_counties_tt
                while = {
                    limit = {
                        OR = {
                            NOT = {
                                exists = scope:flamestrike_count
                            }
                            scope:flamestrike_count <= 9
                        }
                    }

                    if = {
                        limit = {
                            NOT = {
                                exists = scope:flamestrike_count
                            }
                        }

                        save_scope_value_as = {
                            name = flamestrike_count
                            value = 1
                        }
                    }
                    else = {
                        save_scope_value_as = {
                            name = flamestrike_count
                            value = {
                                value = scope:flamestrike_count
                                add = 1
                            }
                        }
                    }
                    every_de_jure_county = {
                        add_county_modifier = {
                            modifier = wc_flamestrike_modifier
                            months = wc_spell_flamestrike_modifier_duration_months_value
                        }
                    }
                }
            }
        }
    }
}

cast_fire_shield_effect = {
    if = {
        limit = { exists = var:fire_shield_recipient }
        var:fire_shield_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:fire_shield
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    if = {
        limit = {
            exists = scope:this_recipient
        }
        scope:this_recipient = {
            add_character_modifier = {
                modifier = wc_fire_shield_modifier
                days = wc_spell_fire_shield_duration_days_value
            }
        }
    }
}

cast_frostfire_bolt_effect = {
    if = {
        limit = { exists = var:frostfire_bolt_recipient }
        var:frostfire_bolt_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:frostfire_bolt
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }
    # need to determine good or bad
    if = {
        limit = {
            OR = {
                any_war_ally = {
                    any_army = {
                        army_commander = scope:this_recipient.army_commander
                    }
                }
                scope:this_recipient.army_commander.top_liege = root
                scope:this_recipient.army_commander.liege = root
                scope:this_recipient.army_commander = root
            }
        }
        scope:this_recipient.army_commander = {
            add_character_modifier = {
                modifier = wc_frostfire_bolt_good_modifier
                days = wc_spell_frostfire_bolt_duration_days_value
            }
            add_opinion = { modifier = wc_casted_helpful_spell target = root }
        }
        scope:this_recipient = {
            custom_tooltip = wc_frostfire_bolt_tt
            set_variable = {
                name = frostfire_bolt_remainder
                value = scope:this_recipient.army_commander
                days = wc_spell_frostfire_bolt_duration_days_value
            }
        }
    }
    else_if = {
        limit = {
            any_war_enemy = {
                any_army = {
                    army_commander = scope:this_recipient.army_commander
                }
            }
        }
        scope:this_recipient.army_commander = {
            add_character_modifier = {
                modifier = wc_frostfire_bolt_bad_modifier
                days = wc_spell_frostfire_bolt_duration_days_value
            }
            add_opinion = { modifier = wc_casted_harmful_spell target = root }
        }
        scope:this_recipient = {
            custom_tooltip = wc_frostfire_bolt_tt
            set_variable = {
                name = frostfire_bolt_remainder
                value = scope:this_recipient.army_commander
                days = wc_spell_frostfire_bolt_duration_days_value
            }
        }
    }
}

cast_frostbolt_effect = {
    if = {
        limit = { exists = var:frostbolt_recipient }
        var:frostbolt_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:frostbolt
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }

    scope:this_recipient = {
        add_character_modifier = {
            modifier = wc_frostbolt_modifier
            days = wc_spell_frostbolt_duration_days_value
        }
        if = { # cannot do a random knight because tooltip and effect will differ.
            limit = {
                NOT = { has_trait = frostbite_3 }
            }
            save_scope_value_as = {
                name = spell_dodge_chance
                value = wc_order_magic_resistance_dodge_value
            }
            random_list = {
                20 = { # TODO: Increase by 80% if hit by Frost Nova
                    add_or_increase_frostbite_effect = yes
                    add_opinion = {
                        modifier = wc_frostbit_me
                        target = root
                    }
                    hidden_effect = {
                        root = {
                            send_interface_toast = {
                                title = wc_spell_hit
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_frostbolt_hit_tt
                            }
                        }
                    }
                }
                80 = {
                    custom_tooltip = wc_frostbolt_resist_tt
                    modifier = {
                        is_alive = yes
                        add = scope:spell_dodge_chance
                    }
                }
            }
        }
    }
}