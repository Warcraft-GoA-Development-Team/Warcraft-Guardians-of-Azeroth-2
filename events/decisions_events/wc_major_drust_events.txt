namespace = drust_crisis

### DRUST INCURSION DECISION EVENTS ###
#Drust King, Gorak Tul contacts the grief-stricken spouse
drust_crisis.1 = {
	type = character_event
	title = drust_crisis.1.t
	desc = drust_crisis.1.desc
	theme = intrigue
	override_background = wc_waycrest_manor

	left_portrait = {
		character = scope:sick_spouse
		animation = sick
	}

	right_portrait = {
		character = scope:worried_spouse
		animation = grief
	}

	# Not even death will do us part
	option = {
		name = drust_crisis.1.a
		
		scope:worried_spouse = {
			add_trait = being_undead
			set_character_faith = faith:throsic
		}
		scope:sick_spouse = {
			add_trait = being_undead
			set_character_faith = faith:throsic
		}
		
		scope:sick_spouse = { trigger_event = drust_crisis.2 }

		title:d_drustwar.holder = {
			# Gives troops
			heartsbane_spawn_starting_troops_effect = yes
			heartsbane_spawn_starting_troops_effect = yes
		}
		
		# Independence stuff goes here
		title:d_drustwar.holder = {
			declare_war_on_kt_heartsbane_effect = yes
		}
		
		# Notify the Admiral
		title:k_kul_tiras.holder = { trigger_event = drust_crisis.3 }

		ai_chance = {
			base = 1
		}
	}

	# I refuse
	option = {
		name = drust_crisis.1.b

		add_character_flag = heartsbane_coven_declined_flag

		custom_tooltip = {
			text = stops_the_event_chain
			remove_global_variable = heartsbane_coven_event_var
			remove_global_variable = drustvar_crisis_ongoing_var	# Blocks summon_gorak_tul
		}

		ai_chance = {
			base = 0
		}
	}
}

#Ping the raised spouse
drust_crisis.2 = {
	type = character_event
	title = drust_crisis.2.t
	desc = drust_crisis.2.desc
	theme = intrigue
	override_background = wc_waycrest_manor

	right_portrait = {
		character = scope:sick_spouse
		animation = disbelief
	}

	left_portrait = { 
		character = scope:worried_spouse
		animation = flirtation
	}

	option = {
		
		name = drust_crisis.2.a # Dynloc is to be used depending on spouse's gender here, if male bargainer, Gorak raises his spouse as Mother of the Heartsbane
	}
}

#Notify the Admiral
drust_crisis.3 = {
	type = character_event
	title = drust_crisis.3.t
	desc = drust_crisis.3.desc
	theme = war
	override_background = wc_boralus
	
	right_portrait = {
		character = title:k_kul_tiras.holder
		animation = worry
	}

	immediate = {
		remove_global_variable = drustvar_crisis_ongoing_var
	}

	option = {
		name = drust_crisis.3.a
	}
}

#Gorak Tul invades - triggered by Summon Gorak Tul decision
drust_crisis.4 = {
	type = character_event
	title = drust_crisis.4.t
	desc = drust_crisis.4.desc
	theme = war
	override_background = wc_death_tree

	immediate = {
		save_scope_as = summoner		
		set_global_variable = drust_incursion_happened		# Locks the crisis opening event if it didn't happen
		
		# Summon Gorak Tul
		create_character = {
			template = gorak_tul_character_template
			save_scope_as = gorak_tul
			location = root.location
		}
		
		# Set up Gorak Tul's assets
		gorak_tul_effect = yes
		gorak_tul_create_court_effect = yes
	}

	left_portrait = {
		character = scope:gorak_tul
		animation = personality_honorable
	}	
	
	right_portrait = {
		character = scope:summoner
		animation = spymaster
	}
	
	lower_left_portrait = {
		character = scope:ingra_maloch
	}
	lower_right_portrait = {
		character = scope:ingra_drif
	}
	lower_center_portrait = {
		character = scope:ingra_saor
	}

	option = {
		name = drust_crisis.4.a
		custom_tooltip = drust_crisis.4.a.tt

		trigger_event = drust_crisis.6
	}
}

#Spawns Drust troops, fires the notifier event
drust_crisis.5 = {
	type = character_event
	hidden = yes

	immediate = {
		gorak_tul_spawn_starting_troops_effect = yes
		gorak_tul_spawn_starting_troops_effect = yes
		
    
		every_player = {
			limit = { get_news_from_region_trigger = { REGION = world_eastern_kingdoms } }
			trigger_event = { id = drust_crisis.7 days = 1 } # Notification
		}
	}
}

# Summoner swears fealty to Gorak Tul
drust_crisis.6 = { 
	type = character_event
	title = drust_crisis.6.t
	desc = drust_crisis.6.desc
	theme = diplomacy
	override_background = wc_death_tree

	immediate = {
		save_scope_as = summoner
		scope:gorak_tul = {
			save_scope_as = gorak_tul
			set_variable = {
				name = summoner
				value = ROOT
			}
		}
	}

	left_portrait = {
		character = ROOT
		animation = celebrate_sword
	}

	right_portrait = {
		character = scope:gorak_tul
		animation = war_over_win
	}

	option = {
		name = drust_crisis.6.a
		set_player_character = scope:gorak_tul
		ai_chance = {
			base = 0
		}
	}

	option = {
		name = drust_crisis.6.b
	}
	after = {
		scope:gorak_tul = {	# Gorak Tul Setup
			create_story = story_drust_incursion
		}
	}
}

#Notify the Eastern Kingdoms
drust_crisis.7 = {
	type = character_event
	window = fullscreen_event
	title = drust_crisis.7.t
	desc = {
		first_valid = {
			triggered_desc = { # Throsic option
				trigger = { faith = faith:throsic }
				desc = drust_crisis.7.drust.desc
			}
			triggered_desc = { # Tirassian/Daeric option
				trigger = { 
						OR = {
							faith = faith:old_ways
							faith = faith:tidemother
						}
					}
				desc = drust_crisis.7.kt.desc				
			}
			desc = drust_crisis.7.others.desc
		}
	}
	theme = war
	override_background = wc_fullscreen_kul_tiras

	option = {
		name = {
			text = {
				first_valid = {
					triggered_desc = { # Throsic option
						trigger = { faith = faith:throsic }
						desc = drust_crisis.7.a
					}
					triggered_desc = { # Tirassian/Daeric option
						trigger = { 
							OR = {
								faith = faith:old_ways
								faith = faith:tidemother
							}
						}
						desc = drust_crisis.7.b
					}
					desc = drust_crisis.7.c # Outsider option
				}
			}
		}
	}
}

# Conquest of Boralus
drust_crisis.8 = {
	title = drust_crisis.8.t
	desc = drust_crisis.8.desc
	type = character_event
	theme = war
	override_background = wc_boralus_siege
	
	left_portrait = {
		character = root
		animation = celebrate_axe
	}
	
	#Kill them all!
	option = {
		trigger = { root = title:b_boralus.barony_controller }
		name = drust_crisis.8.a
		
		drust_bloodshed_effect = { LOCATION = scope:county }
		drust_sack_county_effect = { LOCATION = scope:county }
		take_control_drust_effect = {
			PREVIOUS_HOLDER = title:c_boralus.holder
			NEW_TITLE = scope:county
		}
		change_culture_and_faith_drust_effect = yes
		title:k_drustvar.holder = {
			set_realm_capital = title:c_boralus
		}
	}
	
	# Kill them all! - Notification
	option = {
		trigger = { NOT = { root = title:b_boralus.barony_controller } }
		name = drust_crisis.8.b
		
		show_as_tooltip = {
			drust_bloodshed_effect = { LOCATION = scope:county }
		}
	}
}

# Conquest of Boralus - Boralus side
drust_crisis.9 = {
	title = drust_crisis.9.t
	desc = drust_crisis.9.desc
	type = character_event
	theme = war
	override_background = wc_boralus_siege
	
	right_portrait = {
		character = root
		animation = fear
	}
	
	# For Kul Tiras!
	option = {
		name = drust_crisis.9.a
		custom_tooltip = drust_crisis.9.tt.a
		
		show_as_tooltip = {
			drust_bloodshed_effect = { LOCATION = scope:county }
		}
	}
}

# Sacking of Tiragarde Sound
drust_crisis.10 = {
	title = drust_crisis.10.t
	desc = drust_crisis.10.desc
	type = character_event
	theme = war
	override_background = wc_boralus_siege
	
	left_portrait = {
		character = scope:new_holder
		animation = war_over_win
	}
	
	# Sack everything and capture the remnants
	option = {
		name = drust_crisis.10.a
		custom_tooltip = drust_crisis.10.a.tt
		
		drust_sack_area_effect = { TITLE = title:d_tiragarde }
		change_culture_and_faith_drust_area_effect = {
			TITLE = title:d_tiragarde
			CHARACTER = scope:new_holder
		}
		
		ai_chance = {
			base = 150
		}
	}
	
	# Keep this untouched
	option = {
		name = drust_crisis.10.b
		custom_tooltip = drust_crisis.10.b.tt
		
		add_character_modifier = {
			modifier = brought_discipline_drust_modifier
			years = 2
		}	
		drust_minor_sack_area_effect = { TITLE = title:d_tiragarde }
		
		ai_chance = {
			base = 1
		}
	}
}

######################
# DEBUG EVENT        #
######################


# test event 5 with root as worried spouse
drust_crisis.9005 = { 
	hidden = yes
	orphan = yes

	immediate = { 
		save_scope_as = worried_spouse

		scope:worried_spouse = { 
			random_spouse = { 
				save_scope_as = sick_spouse
			}
			trigger_event = { 
				id = drust_crisis.5
			}
		}
	}
}

# test event 6 with root as sick spouse
drust_crisis.9006 = { 
	hidden = yes
	orphan = yes

	immediate = { 
		save_scope_as = sick_spouse

		scope:sick_spouse = { 
			random_spouse = { 
				save_scope_as = worried_spouse
			}
			trigger_event = { 
				id = drust_crisis.6
			}
		}
	}
}

