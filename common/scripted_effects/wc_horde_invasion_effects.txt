# Determine whether Blackhand exists or not
set_horde_characters_effect = {
	title:c_dark_portal.title_province = {
		save_scope_as = horde_entry_point
	}
	# If started in 583, give Blackhand resources and set major players
	story_owner = {
		save_scope_as = blackhand
	}
	character:10015 = {
		save_scope_as = guldan
	}
	character:10017 = {
		save_scope_as = teron
	}
	character:10019 = {
		save_scope_as = durotan
	}
	character:10050 = {
		save_scope_as = orgrim
	}
	character:52000 = {
		save_scope_as = chogall
	}
	scope:blackhand = {
		add_gold = 250
		add_dread = high_dread
		add_prestige = 750
		dynasty = {
			add_dynasty_prestige_level = 3
			add_dynasty_prestige = 3000
			add_dynasty_perk = warfare_legacy_1
			add_dynasty_perk = warfare_legacy_2
		}
		# Don't spawn armies here, it doesn't work
	}
}

# Give Horde troops
spawn_horde_troops_effect = {
	if = {
		limit = { exists = capital_province }
		spawn_army = {
			uses_supply = no
			inheritable = no
			name = horde_event_troops
			levies = {
				value = 1000
			}
			men_at_arms = {
				type = savage
				stacks = 1
			}
			men_at_arms = {
				type = blackrock_legionnaire
				stacks = 1
			}
			men_at_arms = {
				type = wolfrider
				stacks = 2
			}
			men_at_arms = {
				type = trebuchet
				stacks = 10
			}
			location = capital_province
		}
	}
}

spawn_orc_savage_troops_effect = {
	if = {
		limit = { exists = capital_province }
		spawn_army = {
			uses_supply = no
			inheritable = no
			name = horde_event_troops
			levies = {
				value = 1000
			}
			men_at_arms = {
				type = savage
				stacks = 3
			}
			men_at_arms = {
				type = wolfrider
				stacks = 2
			}
			men_at_arms = {
				type = trebuchet
				stacks = 10
			}
			location = capital_province
		}
	}
}

spawn_orc_blademaster_troops_effect = {
	if = {
		limit = { exists = capital_province }
		spawn_army = {
			uses_supply = no
			inheritable = no
			name = horde_event_troops
			levies = {
				value = 1000
			}
			men_at_arms = {
				type = blademaster
				stacks = 3
			}
			men_at_arms = {
				type = wolfrider
				stacks = 2
			}
			men_at_arms = {
				type = trebuchet
				stacks = 10
			}
			location = capital_province
		}
	}
}

spawn_orc_troops_based_on_culture_effect = {
	if = {
		limit = { culture = { has_innovation = innovation_savage } }
		spawn_orc_savage_troops_effect = yes
	}
	else_if = {
		limit = { culture = { has_innovation = innovation_blademaster } }
		spawn_orc_blademaster_troops_effect = yes
	}
	else = {
		spawn_horde_troops_effect = yes
	}
}

# Declare war on Stormwind
declare_war_on_stormwind_effect = {
	debug_log = "The Horde has declared war on Stormwind!"
	debug_log_date = yes
	
	title:k_stormwind.holder = { save_scope_as = stormwind_holder }
	
	scope:blackhand = {
		add_character_flag = {
			flag = free_mongol_cb
			days = 14
		}
		start_war = {
			cb = mongol_invasion_war
			target = title:k_stormwind.holder
			target_title = title:k_stormwind
		}
	}
}

try_to_set_horde_story_owner = {
	if = {
		limit = { $OWNER$ = { culture = { has_cultural_pillar = heritage_orcish } } }
		$OWNER$ = {
			add_character_modifier = { modifier = great_invader_modifier }
			trigger_event = { id = wc_horde_invasion.0004 days = 1 } #Spawns Horde troops
		}
		make_story_owner = $OWNER$
	}
	else = {
		end_story = yes
	}
}

invite_burning_blade_effect = {
	save_temporary_scope_as = warchief
	title:c_dark_portal.title_province = { save_temporary_scope_as = dark_portal }
	
	#Dharl
	create_character = {
		template = dharl_character_template
		name = "Dharl"
		location = scope:dark_portal
		save_scope_as = dharl
	}
	scope:dharl = {
		# Gives some land
		get_random_county_effect = { GIVER = scope:warchief }
		
		# Creates clan title
		create_title_and_vassal_change = {
			type = created
			save_scope_as = title_creation
			add_claim_on_loss = no
		}
		title:d_burning_blade_clan = {
			change_title_holder = {
				holder = scope:dharl
				change = scope:title_creation
			}
		}
		resolve_title_and_vassal_change = scope:title_creation
		
		# Gives some gold and troops
		horde_clan_start_pack_effect = yes
		clan_setup_effect = { clan = title:d_burning_blade_clan }
	}
}
invite_dragonmaw_effect = {
	save_temporary_scope_as = warchief
	title:c_dark_portal.title_province = { save_temporary_scope_as = dark_portal }
	
	# Zuluhed
	create_character = {
		template = zuluhed_character_template
		name = "Zuluhed"
		location = scope:dark_portal
		save_scope_as = zuluhed
	}
	scope:zuluhed = {
		give_nickname = nick_the_whacked
		
		# Gives some land
		get_random_county_effect = { GIVER = scope:warchief }
		
		# Creates clan title
		create_title_and_vassal_change = {
			type = created
			save_scope_as = title_creation
			add_claim_on_loss = no
		}
		title:d_dragonmaw_clan = {
			change_title_holder = {
				holder = scope:zuluhed
				change = scope:title_creation
			}
		}
		resolve_title_and_vassal_change = scope:title_creation
		
		# Gives some gold and troops
		horde_clan_start_pack_effect = yes
		clan_setup_effect = { clan = title:d_dragonmaw_clan }
	}
	
	#Nekros
	create_character = {
		template = nekros_character_template
		name = "Nekros"
		employer = scope:zuluhed
		save_scope_as = nekros
	}
	
	#Nek'rosh
	create_character = {
		template = nekrosh_character_template
		name = "Nek'rosh"
		father = scope:nekros
		employer = scope:zuluhed
		save_scope_as = nekrosh
	}
}
get_random_county_effect = {
	save_temporary_scope_as = target
	create_title_and_vassal_change = {
		type = granted
		save_scope_as = title_granting
		add_claim_on_loss = no
	}
	$GIVER$ = {
		random_held_title = {
			limit = {
				tier = tier_county
				NOT = { this = $GIVER$.capital_county }
			}
			change_title_holder = {
				holder = scope:target
				change = scope:title_granting
			}
		}
	}
	resolve_title_and_vassal_change = scope:title_granting
}
horde_clan_start_pack_effect = {
	add_gold = 250
	spawn_orc_troops_based_on_culture_effect = yes
	spawn_orc_troops_based_on_culture_effect = yes
}
# Make clan a tribal and assign laws
clan_setup_effect = {
	change_government = tribal_government
	$clan$ = {
		if = {
			limit = { tier >= tier_kingdom }
			add_title_law = saxon_elective_succession_law
		}
	}
}

### WAR EFFECTS ###

take_control_horde_effect = {
	save_temporary_scope_as = target
	$PREVIOUS_HOLDER$ = { save_temporary_scope_as = previous_holder }
	$NEW_TITLE$ = { save_temporary_scope_as = conquered_title }
	
	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = title_conquest
		add_claim_on_loss = yes
	}
	
	scope:previous_holder = {
		scope:conquered_title = {
			change_title_holder = {
				holder = scope:target
				change = scope:title_conquest
				take_baronies = yes
			}
		}
	}
	resolve_title_and_vassal_change = scope:title_conquest

	scope:conquered_title = {
		every_county_province = {
			barony = {
				if = {
					limit = {
						exists = lessee
					}
					revoke_lease = yes
				}
			}
		}
	}
}

change_culture_and_faith_horde_area_effect = {
	$TITLE$ = { save_scope_as = target_title }
	$CHARACTER$ = { save_scope_as = target_character }
	
	
	scope:target_title = { #Only for duchies
		every_de_jure_county = {
			limit = {
				NOT = {
					this.culture = scope:target_character.culture
					this.faith = scope:target_character.faith
				}
			}
			set_county_culture = scope:target_character.culture
			set_county_faith = scope:target_character.faith
		}
	}
}

change_culture_and_faith_horde_effect = {
	save_temporary_scope_as = target
	
	scope:conquered_title = {
		set_county_culture = scope:target.culture
		set_county_faith = scope:target.faith
	}
}

sack_area_effect = {
	$TITLE$ = { save_scope_as = target_title }
	scope:target_title = { #Only for duchies
		every_de_jure_county = {
			limit = {
				NOT = { this = { has_county_modifier = recently_sacked_by_the_horde_modifier } }
			}
			sack_county_effect = { LOCATION = this }
		}
	}
}

sack_county_effect = {
	$LOCATION$ = { save_scope_as = sacked_location }

	root = { add_gold = massive_gold_value }
	scope:sacked_location = {
		change_development_level = { # Lower Dev Level
			value = {
				add = development_level
				multiply = { -0.8 -0.9 }
			}
		}
		
		change_county_control = { # Lower control
			value = { add = monumental_county_control_loss }
		}
		
		add_county_modifier = {
			modifier = recently_sacked_by_the_horde_modifier
			years = 20
		}
		
		every_county_province = {
			if = {
				limit = { # Remove all of the buildings
					NOT = { has_holding_type = tribal_holding }
				}
				set_holding_type = tribal_holding
			}
			
			barony = {
				if = {
					limit = {
						exists = lessee
					}
					revoke_lease = yes
				}
			}
		}
	}
}

minor_sack_area_effect = {
	$TITLE$ = { save_scope_as = target_title }
	scope:target_title = { #Only for duchies
		every_de_jure_county = {
			limit = {
				NOT = { this = { has_county_modifier = recently_sacked_by_the_horde_modifier } }
			}
			minor_sack_county_effect = { LOCATION = this }
		}
	}
}

minor_sack_county_effect = {
	$LOCATION$ = { save_scope_as = sacked_location }

	root = { add_gold = minor_gold_value }
	scope:sacked_location = {
		change_development_level = { # Lower Dev Level
			value = {
				add = development_level
				multiply = { -0.1 -0.2 }
			}
		}
		
		change_county_control = { # Lower control
			value = { add = medium_county_control_loss }
		}
		
		add_county_modifier = {
			modifier = recently_sacked_by_the_horde_modifier
			years = 5
		}
	}
}

horde_bloodshed_area_effect = {
	$TITLE$ = { save_scope_as = target_title }
	scope:target_title = { #Only for duchies
		every_de_jure_county = {
			limit = {
				NOT = { 
					this = { has_county_modifier = recently_sacked_by_the_horde_modifier }
					this.holder = { is_vassal_or_below_of = title:e_horde.holder } 
				}
			}
			horde_bloodshed_effect = { LOCATION = this }
		}
	}
}

horde_bloodshed_effect = {
	$LOCATION$ = { save_scope_as = bloodshed_location }
	set_variable = {
		name = victims_killed
		value = 0
	}

	set_variable = {
		name = victims_enslaved
		value = 0
	}
	
	every_hired_mercenary  = { #Gets mercenaries hired by the Player
		mercenary_company_leader = {
			every_courtier = {
				add_to_temporary_list = hired_characters
			}
			every_vassal_or_below = {
				add_to_temporary_list = hired_characters
			}
			add_to_temporary_list = hired_characters
		}
	}
	every_patroned_holy_order = {
		leader = {
			add_to_temporary_list = hired_characters
		}
	}
	every_vassal_or_below = {
		every_patroned_holy_order = {
			leader = {
				add_to_temporary_list = hired_characters
			}
		}
		every_courtier = {
			add_to_temporary_list = hired_characters
		}
	}


	scope:bloodshed_location = {
		hidden_effect = {
			every_county_province = {
				
				every_character_in_location = {
					limit = {
						NOR = {
							this = root
							is_vassal_or_below_of = root
							employer ?= root
							is_courtier_of = root
							is_in_list = hired_characters
						}
					}
					save_scope_as = victim
					
					random_list = {
						5 = {
							#Nothing
						}
						15 = { 
							# Slave
							prisoner_of_war_capture_effect = {
								TARGET = scope:victim
								IMPRISONER = root
							}
							root = {
								change_variable = {
									name = victims_enslaved
									add = 1
								}
							}
						}
						85 = {
							root = {
								change_variable = {
									name = victims_killed
									add = 1
								}
							}
							override_death_effect = { death_reason = death_horde }
						}
					}
				}
				if = {
					limit = { has_building_or_higher = northshire_abbey_01 }
					remove_building = northshire_abbey_01
				}
				
			}
		}
	}

	hidden_effect = { # Dont unhide this or the TOOLTIP will show 0 people killed
		send_interface_toast = {
			title = horde_bloodshed.t
			add_prestige = medium_prestige_gain
			left_icon = root
			if = {
				limit = {
					NAND = {
						exists = var:victims_enslaved
						exists = var:victims_killed
						var:victims_killed = 0
						var:victims_enslaved = 0
					}
				}
				custom_tooltip = horde_bloodshed.d
			}
		}
		remove_variable = victims_enslaved
		remove_variable = victims_killed	
	}
	
	show_as_tooltip = { custom_tooltip = horde_bloodshed.residents }
}