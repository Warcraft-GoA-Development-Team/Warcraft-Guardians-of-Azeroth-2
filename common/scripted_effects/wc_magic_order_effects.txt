init_order_spells_effect = {
    add_to_global_variable_list = { name = order_spells target = flag:scorch }
    add_to_global_variable_list = { name = order_spells target = flag:pyroblast }
}

cast_scorch_effect = {
    if = {
        limit = { exists = var:scorch_recipient }
        var:scorch_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:scorch
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }

    scope:this_recipient = {
        if = { # cannot do a random knight because tooltip and effect will differ.
            limit = {
                NOT = { has_trait = burned_3 }
            }
            save_scope_value_as = {
                name = spell_dodge_chance
                value = wc_order_magic_resistance_dodge_value
            }
            random_list = {
                100 = {
                    add_or_increase_burned_effect = yes
                    add_opinion = {
                        modifier = wc_burned_me
                        target = root
                    }
                    hidden_effect = {
                        root = {
                            send_interface_toast = {
                                title = wc_spell_hit
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_scorch_hit_tt
                            }
                        }
                    }
                }
                20 = {
                    custom_tooltip = wc_scorch_resist_tt
                    modifier = {
                        is_alive = yes
                        add = scope:spell_dodge_chance
                    }
                    hidden_effect = {
                        root = {
                            send_interface_toast = {
                                title = wc_spell_dodged
                                left_icon = scope:this_recipient
                                right_icon = root
                                custom_tooltip = wc_scorch_dodge
                            }
                        }
                    }
                }
            }
        }
    }
}

cast_pyroblast_effect = {
    if = {
        limit = { exists = var:pyroblast_recipient }
        var:pyroblast_recipient = {
            save_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:pyroblast
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_scope_as = this_recipient
        }
    }
    if = {
        limit = {
            OR = {
                any_war_enemy = {
                    any_army = {
                        army_commander = scope:this_recipient.army_commander
                    }
                }
            }
        }
        scope:this_recipient.army_commander = {
            if = {
                limit = {
                    NOT = {
                        has_trait = burned_3
                    }
                }

                save_scope_value_as = {
                    name = spell_dodge_chance
                    value = wc_order_magic_resistance_dodge_value
                }
                random_list = {
                    100 = {
                        add_or_increase_burned_effect = yes
                        add_opinion = {
                            modifier = wc_burned_me
                            target = root
                        }
                        hidden_effect = {
                            save_temporary_scope_as = dodger
                            root = {
                                send_interface_toast = {
                                    title = wc_spell_hit
                                    left_icon = prev
                                    right_icon = root
                                    custom_tooltip = wc_pyroblast_hit_tt
                                }
                            }
                        }
                    }
                    20 = {
                        custom_tooltip = wc_pyroblast_resist_tt
                        modifier = {
                            is_alive = yes
                            add = scope:spell_dodge_chance
                        }
                        hidden_effect = {
                            save_temporary_scope_as = dodger
                            root = {
                                send_interface_toast = {
                                    title = wc_spell_dodged
                                    left_icon = prev
                                    right_icon = root
                                    custom_tooltip = wc_pyroblast_dodge
                                }
                            }
                        }
                    }
                }
            }
        }

        custom_tooltip = {
            text = wc_spell_pyroblast_knights_tt
            scope:this_recipient.army_owner = {
                every_knight = {
                    limit = {
                        exists = knight_army
                        knight_army = scope:this_recipient
                    }

                    if = {
                        limit = {
                            NOT = {
                                has_trait = burned_3
                            }
                        }

                        save_scope_value_as = {
                            name = spell_dodge_chance
                            value = wc_order_magic_resistance_dodge_value
                        }
                        random_list = {
                            100 = {
                                add_or_increase_burned_effect = yes
                                add_opinion = {
                                    modifier = wc_burned_me
                                    target = root
                                }
                                hidden_effect = {
                                    save_temporary_scope_as = dodger
                                    root = {
                                        send_interface_toast = {
                                            title = wc_spell_hit
                                            left_icon = prev
                                            right_icon = root
                                            custom_tooltip = wc_pyroblast_hit_tt
                                        }
                                    }
                                }
                            }
                            20 = {
                                custom_tooltip = wc_pyroblast_resist_tt
                                modifier = {
                                    is_alive = yes
                                    add = scope:spell_dodge_chance
                                }
                                hidden_effect = {
                                    save_temporary_scope_as = dodger
                                    root = {
                                        send_interface_toast = {
                                            title = wc_spell_dodged
                                            left_icon = prev
                                            right_icon = root
                                            custom_tooltip = wc_pyroblast_dodge
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}