namespace = lordaeron 

##############################################
# 1001 - 1099: Reclamation of Lordaeron Events
##############################################

lordaeron.1001 = { 

	type = character_event
	title = lordaeron.1001.title
	desc = lordaeron.1001.desc
	theme = stewardship
	override_background = market

	immediate = { 
		title:b_lordaeron.title_province = { 
			remove_building = ruined_palace_01
			add_special_building = ruined_palace_02 
		}
		title:b_lordaeron = {
			remove_variable = develop_the_undercity
			set_variable = { name = develop_the_undercity value = flag:finished }
			hidden_effect = { if = { limit = { var:develop_the_undercity = flag:finished } } } #error.log
		}
		title:c_lordaeron = {
			set_county_culture = culture:forsaken
		}
	}

	right_portrait = { 
		character = root
		animation = steward
	}

	trigger = {
		title:b_lordaeron = {
			holder = { 	
				OR = {
					AND = { 	# make sure i have the title...
						is_of_forsaken_like_culture = yes 	
						this = root
					}
					AND = { 	# or that I gave out the title to someome...
						self_or_liege_is_of_forsaken_like_culture = yes 
						any_liege_or_above = {this = root }
					}
				}
			} 
			var:develop_the_undercity ?= flag:construction
		}
	}

	#TODO: use a story cycle to handle complex fails such as sylvanas_character deaths
	on_trigger_fail = { 
		title:b_lordaeron.holder = { 
			if = { 
				limit = { NOT = { this = root } self_or_liege_is_of_forsaken_like_culture = yes } 
				trigger_event = { id = lordaeron.1001 days = 1 }
			}
			else = { 
				trigger_event = { id = lordaeron.1002 days = 1 }
			}
		}
	}

	option = { 
		name = lordaeron.1001.opt.a

		show_as_tooltip = { 
			custom_tooltip = lordaeron.1001.tooltip.a
		}

		hidden_effect = { 
			global_var:sylvanas_character = { 
				if = {
					limit = { is_alive = yes }
					trigger_event = { 
						id = lordaeron.1101 
						years = 2
						delayed = yes
					}
				}
			}

			every_vassal_or_below = {
				limit = { 
					faith.religion = { is_in_family = rf_shadow }
					NOT = { government_has_flag = government_is_theocracy }
				}
				add_to_temporary_list = tmp_courts
			}
			while = { 
				count = 3 # in three different courts...
				random_in_list = { 
					list = tmp_courts
					every_courtier_or_guest = {
						limit = {
							NAND = { 
								has_council_position = councillor_court_chaplain
								NOR = { 
									faith = faith:forgotten_shadow 
									piety_level >= 2 
									exists = secret_faith 
								}
								NOR = { has_trait = zealous has_trait = loyal has_trait = holy_warrior has_trait = stubborn }
							}
						}
						add_to_temporary_list = tmp_potential_cryptos
					}
					remove_from_list = tmp_courts
				}
			} 
			
			while = { 
				count = 4 # ...four different people will convert to forgotten shadow
				random_in_list = { 
					list = tmp_potential_cryptos
					make_character_crypto_religionist_effect = { CRYPTO_RELIGION = faith:forgotten_shadow }
					remove_from_list = tmp_potential_cryptos
				}
			}
			#total: 12 characters will adopt Forgotten Shadow secretly
			#TODO: Link the random vassals to the next event? could be cool to have secret faith characters randomly dispersed tho
		}
	}

}

# Failed construction of Undercity
lordaeron.1002 = { 

	type = character_event
	title = lordaeron.1002.title
	desc = lordaeron.1002.desc
	theme = dungeon
	override_background = market

	right_portrait = { 
		character = root
		animation = stress
	}

	immediate = { 
		title:b_lordaeron = {
			title_province = {
				remove_province_modifier = wc_building_undercity
			}
			set_variable = { 
				name = develop_the_undercity
				value = flag:interruption
				years = 5
			}
			hidden_effect = { if = { limit = { var:develop_the_undercity = flag:interruption } } }
		}
		
	}

	option = { 
		name = lordaeron.1002.opt.a
		show_as_tooltip = { 
			custom_tooltip = lordaeron.1002.tooltip.a
		}
	}
	
}

# Change in story ownership
# lordaeron.1003 = { 

# 	type = character_event
# 	title = lordaeron.1003.title
# 	desc = lordaeron.1003.desc
# 	theme = intrigue

# 	right_portrait = { 
# 		character = root
# 		animation = stress
# 	}

# 	immediate = { 
# 	}

# 	option = { 
# 		name = lordaeron.1002.opt.a
# 		show_as_tooltip = { 
# 			custom_tooltip = lordaeron.1002.tooltip.a
# 		}
# 	}
	
# }


#####################################
#1100 - 1199: Post-Reclamation events
#####################################

#1100 - 1109: Selenite Revival

#lordaeron.1100 = { } Selenite Revival Redirect event in case Lordaeron changes hands

lordaeron.1101 = { 

	type = character_event
	title = lordaeron.1101.title
	desc = lordaeron.1101.desc
	theme = faith
	override_background = wc_undercity_throne_room

	immediate = {
		every_vassal_or_below = {
			limit = {
				faith.religion = { is_in_family = rf_shadow }
				highest_held_title_tier >= tier_county
				NOR = { 
					faith = faith:forgotten_shadow 
					government_has_flag = government_is_theocracy 
					piety_level >= 2 
				}
				NOR = { has_trait = zealous has_trait = loyal has_trait = holy_warrior has_trait = stubborn }
			}
			add_to_temporary_list = tmp_selinites
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_1 
			scope:selinite_1 = { remove_from_list = tmp_selinites }
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_2
			scope:selinite_2 = { remove_from_list = tmp_selinites }
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_3 
			scope:selinite_3 = { remove_from_list = tmp_selinites }
		}
	}

	right_portrait = { 
		character = root
		animation = worry
	}

	lower_left_portrait = {
		character = scope:selinite_1
	}

	lower_center_portrait = { 
		character = scope:selinite_2
	}

	lower_right_portrait = { 
		character = scope:selinite_3
	}

	trigger = {
		self_or_liege_is_of_forsaken_like_culture = yes
	}

	option = { 
		# retain sylvanas cult of personality - AI chance 75
		name = lordaeron.1101.opt.a
		title:c_lordaeron = { 
			set_county_faith = faith:forsaken_cult
		}
		add_character_modifier = { 
			modifier = wc_forsaken_subsumed_selinite_modifier
		}
		custom_tooltip = { 
			text = damned_will_convert_to_forsaken_cult
			trigger_event = { 
				id = lordaeron.1102
			}
		}
		ai_chance = { 
			base = 75
			ai_value_modifier = {
				ai_honor = -0.5
				ai_compassion = -1
				ai_boldness = 1
				ai_rationality = 1
			}
		}
	}

	option = { 
		# convert and delegate religious authority to cult of forgotten shadow - AI chance 20
		name = lordaeron.1101.opt.b

		trigger = { NOT = { any_held_title = { is_head_of_faith = yes } } }

		set_character_faith = faith:forgotten_shadow
		title:c_lordaeron = { 
			set_county_faith = faith:forgotten_shadow
		} 

		custom_tooltip = { 
			text = cultists_will_convert_to_forgotten_shadow
			trigger_event = lordaeron.1103
		}

		add_character_modifier = wc_forsaken_embraced_selinite_modifier
		ai_chance = { 
			base = 20
			ai_value_modifier = {
				ai_honor = -0.5
				ai_boldness = 1
				ai_zeal = -1
			}
		}
	}

	option = { 
		# retain cult of personality but grant religious freedom to selinites - AI chance 5
		name = lordaeron.1101.opt.c
		#vassal_contract_set_obligation_level = { type = religious_rights level = 1 } wanted to do this but necro govt blocks it
		random_list = { 
			55 = { 
				modifier = { add = 5    has_trait = zealous}
				modifier = { add = 5    piety_level >= 3 } 
				modifier = { add = 5    piety_level >= 4 }
				modifier = { add = 5    learning > decent_skill_rating }
				modifier = { add = 5    dread > 20 }
				modifier = { add = 5    dread > 40 } 
				modifier = { add = 5    dread > 60 } 
				modifier = { add = -15  dread > 80 } 
				# modifier for court chaplain piety level or intelligence?
				title:c_lordaeron = { 
					set_county_faith = faith:forsaken_cult
				}
			}
			45 = { 
				title:c_lordaeron = { 
					set_county_faith = faith:forgotten_shadow
				}
			}
		}
		add_character_modifier = { 
			modifier = wc_forsaken_tolerated_selinite_modifier
		}
		ai_chance = { 
			base = 5
			ai_value_modifier = {
				ai_honor = 0.5
				ai_compassion = 1
				ai_boldness = -1
				ai_zeal = -1
			}
		}
	}
}

lordaeron.1102 = { 
	hidden = yes 
	type = character_event

	immediate = { 

		save_scope_as = actor

		primary_title = {
			every_in_de_facto_hierarchy = {
				limit = { 
					tier = tier_county  
					faith = faith:death_god 
				}
				set_county_faith = faith:forsaken_cult 
			}
		}

		every_courtier_or_guest = {
			limit = { 
				OR = {
					culture = culture:scourge
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes
		}

		every_vassal_or_below = { 
			limit = { 
				OR = {
					culture = culture:scourge 
					faith = faith:death_god
				}
			}

			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes

			every_courtier_or_guest = {
				limit = { 
					OR = {
						culture = culture:scourge
						faith = faith:death_god
					}
				}
				save_temporary_scope_as = recipient
				new_faith_created_conversion_effect = yes
			}
		}
	}
}

lordaeron.1103 = { 
	hidden = yes 
	type = character_event

	immediate = { 
		save_temporary_scope_as = recipient 
		save_scope_as = actor 

		new_faith_created_conversion_effect = yes

		every_courtier_or_guest = {
			limit = { 
				OR = {
					culture = culture:forsaken 
					faith = faith:forsaken_cult
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes
		}

		every_vassal_or_below = { 
			limit = { 
				OR = {
					culture = culture:forsaken 
					faith = faith:forsaken_cult
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes

			every_courtier_or_guest = {
				limit = { 
					OR = {
						culture = culture:forsaken 
						faith = faith:forsaken_cult
						faith = faith:death_god
					}
				}
				save_temporary_scope_as = recipient
				new_faith_created_conversion_effect = yes
			}
		}
	}
}


######################################
#9000 - 9099: Random occurrence events
######################################

# religious minority caught stealing arcane works
lordaeron.9001 = { 

	type = character_event
	title = lordaeron.9001.title
	theme = intrigue

	desc = { 
		first_valid = { 
			triggered_desc = { 
				trigger = { scope:new_character.faith = faith:echo_of_life }
				desc = lordaeron.9001.desc.echoseeker
			}
			triggered_desc = { 
				trigger = { scope:new_character.faith = faith:alchemical_materialism }
				desc = lordaeron.9001.desc.alchemist
			}
			triggered_desc = { 
				trigger = { scope:new_character.faith = faith:forsaken_cult }
				desc = lordaeron.9001.desc.forsaken
			}
			desc = lordaeron.9001.desc.forgotten
		}
	}

	immediate = { 
		
		create_character = {
			age = { 18 40 }
			diplomacy = { min_template_low_skill max_template_decent_skill }
			martial = { min_template_low_skill max_template_low_skill }
			stewardship = { min_template_low_skill max_template_average_skill }
			intrigue = { min_template_decent_skill max_template_decent_skill }
			learning = { min_template_decent_skill max_template_decent_skill }
			faith = faith:holy_light
			culture = root.culture
			location = root.location
			random_traits_list = {
				count = 1
				education_intrigue_2 = {}
				education_learning_2 = {}
			}
			random_traits = yes
			gender_female_chance = 50
			save_scope_as = new_character
			after_creation = { 
				trigger_race_giving_no_gene_effect = yes
				become_undead_effect = yes
				random_list = { 
					50 = {
						modifier = { 
							factor = 0
							root.faith = faith:echo_of_life
						}
						set_character_faith = faith:echo_of_life 
					}
					50 = { 
						modifier = { 
							factor = 0
							OR = { 
								root.faith = faith:alchemical_materialism 
								NOT = { 
									title:b_lordaeron = { 
										var:develop_the_undercity ?= flag:finished
									}
								}
							}
						}
						set_character_faith = faith:alchemical_materialism 
					}
					50 = {
						trigger = { 
							OR = { 
								root.faith = faith:echo_of_life
								root.faith = faith:alchemical_materialism
							}
							title:b_lordaeron = { 
								var:develop_the_undercity ?= flag:finished
							}
						}
						set_character_faith = faith:forgotten_shadow 
						add_trait = devoted
					}
					50 = {
						trigger = { 
							OR = { 
								root.faith = faith:echo_of_life
								root.faith = faith:alchemical_materialism
							}
							NOT = { 
								title:b_lordaeron = { 
									var:develop_the_undercity ?= flag:finished
								}
							}
						}
						set_character_faith = faith:forsaken_cult
					}
				}
			}
		} 
		hidden_effect = {
			add_visiting_courtier = scope:new_character
			add_opinion = { 
				target = scope:new_character
				modifier = theft_opinion
			}
		}
	}

	right_portrait = { 
		character = scope:new_character
		animation = shame
	}

	left_portrait = { 
		character = root
		animation = disapproval
	}

	#execute them
	option = { 
		name = lordaeron.9000.opt.e
		show_as_tooltip = {
			execute_prisoner_effect = {
				VICTIM = scope:new_character
				EXECUTIONER = root
			}
		}
		add_dread = 5
		add_character_modifier = { 
			modifier = wc_executed_religious_minority_modifier
			years = 2
		}
	}

	#imprison them
	option = { 
		name = lordaeron.9000.opt.a
		imprison_character_effect = {
			TARGET = scope:new_character
			IMPRISONER = root
		}
	}

	#fine them
	option = { 
		name = lordaeron.9000.opt.b
		trigger = { 
			NOT = { scope:new_character.faith = faith:forsaken_cult}
			stewardship >= decent_skill_rating 
		}
		add_gold = 50
		add_hook = {
			type = indebted_hook
			target = scope:new_character
		} 
		remove_courtier_or_guest = { 
			character = scope:new_character
			new_location = title:b_dalaran.title_province
		}
	}

	#invite them to court and get hook
	option = { 
		name = lordaeron.9000.opt.c
		trigger = { NOT = { scope:new_character.faith = faith:forsaken_cult}}
		scope:new_character = { 
			progress_towards_friend_effect = {
				REASON = friend_showed_mercy
				CHARACTER = root
				OPINION = 50
			}
		}
		add_hook = {
			target = scope:new_character
			type = loyalty_hook
		}
	}

	#give them passage to Dalaran and get hook
	option = { 
		name = lordaeron.9000.opt.d
		trigger = { learning >= decent_skill_rating }
		add_hook = {
			target = scope:new_character
			type = loyalty_hook
		}
		show_as_tooltip = { 
			random_list = { 
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_dalaran.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_caer_darrow.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_karazhan.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_gnomeregan.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_falthrien.title_province
					}
				}
				25 = { 
					trigger = { in_diplomatic_range = title:b_narthalas_ruins.holder}
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_narthalas_ruins.title_province
					}
				}
				
			}
		}
	}
}
