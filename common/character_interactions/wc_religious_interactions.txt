##########################
# Purge of Heresy tenets #
# by ElMariuso and Dione #
##########################

# A scarlet marked person will surrender
surrender_to_the_inquisition_interaction  = {
	category = interaction_category_heresy
	common_interaction = yes #suppress error
	icon = surrender_to_the_inquisition
	
	desc = surrender_to_the_inquisition_interaction_desc
	
	is_shown = {
		scope:actor = { # You must have a liege or a head of faith, otherwise no one can imprison u
			OR = {
				exists = faith.religious_head # There is a religious head
				AND = { # Your liege has a court chaplain
					liege ?= { is_independent_ruler = yes }
					liege ?= { exists = cp:councillor_court_chaplain }
				}
			}
			OR = { # You can do it when it's shown on you or any priest, but it will still affect only you. just makes it easier to access 
				scope:recipient = scope:actor
				scope:recipient ?= faith.religious_head

				AND = {
					exists = liege.cp:councillor_court_chaplain
					scope:recipient ?= liege.cp:councillor_court_chaplain
				}
			}
			NOT = {
				liege ?= {
					cp:councillor_court_chaplain = scope:actor # you cant be court chaplain
				}
				faith.religious_head ?= scope:actor # you cant be high inquisitor
			}
		}
		scope:actor.faith = {
			has_doctrine = tenet_purge_of_heresy
			has_doctrine = doctrine_spiritual_head
		}
		scope:actor = {
			OR = {
				is_criminal_in_faith_trigger = { FAITH = faith }
				has_trait = scarlet_mark
			}
			is_imprisoned = no
			is_adult = yes
			is_incapable = no
		}
	}
	
	is_valid_showing_failures_only = {
		scope:actor = {
			age >= age_12_value
			prestige >= medium_prestige_value
			custom_description = {
				text = "hof_interaction_unreformed_faith"
				NOT = {
					faith = { has_doctrine_parameter = unreformed }
				}
			}
			is_at_war = no
			is_incapable = no
		}
	}
	
	cost = {
		prestige = medium_prestige_value
	}
	
	on_accept = {
		scope:actor = {
			stress_impact = {
				zealous = minor_stress_impact_loss
				brave = minor_stress_impact_loss
				honest = minor_stress_impact_loss
				
				craven = massive_stress_impact_gain
				ambitious = massive_stress_impact_gain
				shy = medium_stress_impact_gain
				paranoid = massive_stress_impact_gain
				cynical = medium_stress_impact_gain
			}
			show_as_tooltip = { surrender_to_inquistion_effect = yes }
		}
		
		if = {
			# Head of faith
			limit = { scope:actor = { exists = scope:actor.faith.religious_head } }
			scope:actor.faith.religious_head = {
				save_scope_as = inquisitor
				trigger_event = wc_religious_interaction.1010				
			}
		}
		else_if = { # Your liege's court chaplain
			limit = {
				scope:actor = {
					liege ?= { is_independent_ruler = yes }
					liege ?= { exists = cp:councillor_court_chaplain }
				}
			}
			scope:actor.liege.cp:councillor_court_chaplain = {
				save_scope_as = inquisitor
				trigger_event = wc_religious_interaction.1010		
			}
		}
	}
	
	# AI will do
	
	ai_potential = {
		is_adult = yes
		prestige >= medium_prestige_value
	}
	
	ai_targets = {
		ai_recipients = self
		ai_recipients = scripted_relations
	}
	
	ai_frequency = 6
	
	ai_will_do = {
		base = 30
		ai_value_modifier = { # Those with honor and those who are zealous will repent
			who = scope:actor
			ai_zeal = 0.5
			ai_honor = 0.2
		}
		modifier = { # Those with sinful traits won't repent.
			add = {
				add = 5
				multiply = scope:actor.num_sinful_traits
				multiply = -1
			}
			scope:actor.num_sinful_traits > 0
		}
		modifier = { # Those who are scared of their head of faith will repent
			add = 25
			AND = {
				exists = scope:actor.faith.religious_head 
				has_dread_level_towards = {
					target = scope:actor.faith.religious_head 
					level >= 1
				}
			}
		}
		modifier = { # Same as above but liege's court chaplain if no head of faith
			add = 25
			AND = {
				NOT = { exists = scope:actor.faith.religious_head }
				liege ?= { exists = cp:councillor_court_chaplain }
				has_dread_level_towards = {
					target = scope:actor.liege.cp:councillor_court_chaplain 
					level >= 1
				}
			}
		}
		modifier = { # A bit more likely to do it if they've had the mark for a long time.
			add = 15
			NOT = { has_character_modifier = recent_scarlet_mark_modifier }
		}
		modifier = { # A bit more likely to do it if they've done it before
			add = 10
			has_character_modifier = scarlet_mark_recently_lifted_modifier 
		}
	}
}

give_scarlet_mark_interaction = {
	category = interaction_category_heresy
	common_interaction = yes #suppress error
	icon = scarlet_mark
	
	desc = give_scarlet_mark_interaction_desc

	is_shown = {
		scope:actor = {
			trigger_if = {
				limit = { exists = faith.religious_head }
				this = faith.religious_head
			}
			trigger_else = {
				liege ?= { is_independent_ruler = yes }
				is_independent_ruler = no
				is_in_same_realm_as_target = { CHARACTER = scope:recipient } 
				has_council_position = councillor_court_chaplain
			}
		}

		scope:actor.faith = {
			this = scope:recipient.faith
			has_doctrine = tenet_purge_of_heresy
			has_doctrine = doctrine_spiritual_head
		}

		NOT = {
			scope:recipient = {
				has_trait = scarlet_mark # The target has already the scarlet mark
			}
		}

		NOT = { #Don't do this to yourself
			scope:recipient = scope:actor 
		}
	}

	is_valid_showing_failures_only = {
		scope:recipient = {
			age >= age_12_value
		}
		scope:actor = {
			piety >= medium_piety_value
		}
		scope:actor = {
			custom_description = {
				text = "hof_interaction_unreformed_faith"
				NOT = {
					faith = { has_doctrine_parameter = unreformed }
				}
			}
		}
		scope:recipient = { NOT = { has_strong_hook = scope:actor } }
		custom_tooltip = {
			text = cannot_take_overt_hostile_actions_against_diarch.tt
			NOT = { scope:recipient ?= scope:actor.diarch }
		}
	}

	auto_accept = yes
	force_notification = yes
	notification_text = wc_religious_interaction.1021
	
	on_accept = {
		scope:actor = {
			add_piety = minor_piety_loss
			hidden_effect = {
				send_interface_toast = {	
					title = give_scarlet_mark_interaction_desc.tt
					left_icon = scope:recipient
					scope:recipient = {
						show_as_tooltip = { add_trait = scarlet_mark }
					}
				}
			}
		}

		scarlet_mark_character = {
			REQUESTING_CHARACTER = scope:actor
			TARGET_CHARACTER = scope:recipient
		}

		scope:recipient = {
			hidden_effect = { #Nudge towards rivalry
				if = {
					limit = {
						NOR = {
							has_relation_rival = scope:actor
							has_relation_potential_rival = scope:actor
						}
					}
					set_relation_potential_rival = scope:actor
				}
			}
		}
	}
	
	# AI will do
	
	ai_potential = {
		is_adult = yes
		piety >= medium_piety_value
	}
	
	ai_target_quick_trigger = {
		adult = yes
	}

	ai_targets = {
		ai_recipients = scripted_relations
		ai_recipients = primary_war_enemies
	}
	
	ai_frequency = 13

	ai_will_do = {
		base = 40

		ai_value_modifier = {
			who = scope:actor
			ai_vengefulness = 0.5
		}
		
		modifier = {
			add = {
				add = 10
				multiply = scope:recipient.num_sinful_traits
			}
			scope:recipient.num_sinful_traits > 0
			desc = EXCOMMUNICATION_SINS
		}
	}
}

lift_scarlet_mark_interaction = {
	category = interaction_category_heresy
	icon = scarlet_mark

	common_interaction = yes

	desc = lift_scarlet_mark_interaction_desc

	is_shown = {
		scope:actor = {
			trigger_if = {
				limit = { exists = faith.religious_head }
				this = faith.religious_head
			}
			trigger_else = {
				liege ?= { is_independent_ruler = yes }
				scope:recipient.liege = liege
				NOT = { this = liege }
				has_council_position = councillor_court_chaplain
			}
		}
		scope:actor.faith = {
			this = scope:recipient.faith
			has_doctrine = tenet_purge_of_heresy
			has_doctrine = doctrine_spiritual_head
		}
		scope:recipient = {
			has_trait = scarlet_mark
		}
	}

	is_valid_showing_failures_only = {
		scope:recipient = { is_busy_in_events_localised = yes }
		scope:actor = {
			NOT = {
				is_at_war_with = scope:recipient
			}
		}
	}

	auto_accept = yes
	force_notification = yes
	notification_text = wc_religious_interaction.1024

	on_accept = {
		lift_character_scarlet_mark_effect = {
			TARGET_CHARACTER = scope:recipient
			REQUESTING_CHARACTER = scope:actor
		}
	}
	
	# AI will do
	
	ai_potential = {
		is_adult = yes
		piety >= major_piety_value
	}
	
	ai_target_quick_trigger = {
		adult = yes
	}

	ai_targets = {
		ai_recipients = scripted_relations
		ai_recipients = war_allies
	}
	
	ai_frequency = 50

	ai_will_do = {
		base = 10

		ai_value_modifier = { # +50 to -50
			who = scope:actor
			ai_compassion = 0.5
		}
		
		modifier = {
			factor = 0
			scope:recipient = {
				NOR = {
					has_relation_friend = scope:actor
					has_relation_best_friend = scope:actor
					is_allied_to = scope:actor
				}
			}
		}
	}
}

request_scarlet_mark_interaction = {
	category = interaction_category_heresy
	icon = scarlet_mark

	desc = request_scarlet_mark_interaction_desc
	redirect = {
		if = {
			limit = {
				exists = scope:actor.faith.religious_head
			}
			scope:recipient = {
				save_scope_as = secondary_recipient
			}
			scope:actor.faith.religious_head = {
				save_scope_as = recipient
			}
		}
		else_if = {
			limit = {
				exists = scope:actor.liege.cp:councillor_court_chaplain
			}
			scope:recipient = {
				save_scope_as = secondary_recipient
			}
			scope:actor.liege.cp:councillor_court_chaplain = {
				save_scope_as = recipient
			}
		}
	}

	notification_text = RELIGIOUS_HEAD_REQUEST_SCARLET_MARK

	is_shown = {
		scope:actor = {
			trigger_if = {
				limit = { exists = faith.religious_head }
				NOT = { scope:secondary_recipient = faith.religious_head }
			}
			trigger_else = {
				liege ?= { is_independent_ruler = yes }
				exists = liege.cp:councillor_court_chaplain
				NOT = { scope:secondary_recipient = liege.cp:councillor_court_chaplain }
				is_in_same_realm_as_target = { CHARACTER = scope:secondary_recipient } 
			}
		}
		scope:actor.faith = {
			this = scope:secondary_recipient.faith
			has_doctrine = tenet_purge_of_heresy
			has_doctrine = doctrine_spiritual_head
		}
		NOT = { 
			scope:secondary_recipient = { 
				has_trait = scarlet_mark
			}
		}
		# Can't Request yourself
		NOT = {
			scope:actor = scope:secondary_recipient
		}
	}

	is_valid_showing_failures_only = {
		scope:actor = {
			piety >= medium_piety_value
		}
		scope:secondary_recipient = { #Scarlet Mark target
			age >= age_12_value
		}
		scope:actor = {
			custom_description = {
				text = "hof_interaction_unreformed_faith"
				NOT = {
					faith = { has_doctrine_parameter = unreformed }
				}
			}
			NOT = {
				is_at_war_with = scope:recipient
			}
		}
		scope:recipient = { is_busy_in_events_localised = yes }
		scope:secondary_recipient = { NOT = { has_strong_hook = scope:actor } }
		custom_tooltip = {
			text = cannot_take_overt_hostile_actions_against_diarch.tt
			NOT = { scope:recipient ?= scope:actor.diarch }
		}
	}

	send_option = {
		is_valid = {
			scope:actor = {
				has_usable_hook = scope:recipient
			}
		}
		flag = scarlet_mark_hook
		localization = EXCOMMUNICATION_HOOK
	}
	should_use_extra_icon = {
		scope:actor = { has_usable_hook = scope:recipient }
	}
	extra_icon = "gfx/interface/icons/character_interactions/hook_icon.dds"

	send_options_exclusive = no

	auto_accept = {
		custom_description = {
			text = "spending_hook"
			subject = scope:actor
			object = scope:recipient
			scope:scarlet_mark_hook = yes
			scope:actor = { has_strong_hook = scope:recipient }
		}
	}

	ai_accept = {
		base = -15
			
		modifier = {
			scope:scarlet_mark_hook = yes
			add = 50
			desc = SCHEME_WEAK_HOOK_USED
		}
		opinion_modifier = {
			who = scope:recipient # Head of Faith or Court Chaplain
			opinion_target = scope:actor
			multiplier = 1
		}
		opinion_modifier = {
			who = scope:recipient 
			opinion_target = scope:secondary_recipient #Scarlet Mark target
			multiplier = -1
			min = 0
		}
		modifier = {
			add = -40
			scope:recipient = {
				opinion = {
					value > 0
					target = scope:secondary_recipient #Scarlet Mark target
				}
			}
			desc = EXCOMMUNICATION_OPINION
		}
		modifier = {
			add = {
				add = 10
				multiply = scope:secondary_recipient.num_sinful_traits
			}
			scope:secondary_recipient.num_sinful_traits > 0
			desc = EXCOMMUNICATION_SINS
		}
		modifier = {
			desc = RELIGIOUS_HEAD_INTERACTION_PARAGON
			add = 15
			scope:actor = {
				has_trait = paragon
			}
		}
		modifier = {
			desc = RELIGIOUS_HEAD_INTERACTION_CONSECRATED_BLOOD
			add = 5
			scope:actor = {
				has_trait = consecrated_blood
			}
		}
	}
	
	ai_min_reply_days = 1
	ai_max_reply_days = 5

	on_accept = {
		if = {
			limit = {
				scope:secondary_recipient = { is_alive = yes }
			}
			if = {
				limit = { scope:scarlet_mark_hook = yes }
				scope:actor = {
					use_hook = scope:recipient
				}
			}

			scope:actor = {
				#Spend piety for the scarlet mark
				add_piety = medium_piety_loss

				#Letter event to inform character the inquisitor agreed to their request. # Need changes
				trigger_event = {
					id = wc_religious_interaction.1022
				}
			}
			scarlet_mark_character = {
				TARGET_CHARACTER = scope:secondary_recipient
				REQUESTING_CHARACTER = scope:actor
			}
			scope:secondary_recipient = {
				#Letter event to inform character that they have been scarlet marked # Need changes
				trigger_event = {
					id = wc_religious_interaction.1020
				}
				hidden_effect = { #Nudge towards rivalry
					if = {
						limit = {
							NOR = {
								has_relation_rival = scope:actor
								has_relation_potential_rival = scope:actor
							}
							scope:actor = { is_alive = yes }
						}
						set_relation_potential_rival = scope:actor
					}
				}
			}
		}
	}

	on_decline = {
		scope:actor = {
			#Letter event to inform character the inquisitor refused their request. # Need changes
			trigger_event = {
				id = wc_religious_interaction.1023
			}
		}
	}
	
	# AI will do
	
	ai_potential = {
		is_adult = yes
		piety >= medium_piety_value
	}
	
	ai_target_quick_trigger = {
		adult = yes
	}

	ai_targets = {
		ai_recipients = scripted_relations
		ai_recipients = primary_war_enemies
	}
	
	ai_frequency = 16

	ai_will_do = {
		base = 20

		ai_value_modifier = { # +50 to -50
			who = scope:actor
			ai_zeal = 0.2
			ai_vengefulness = 0.5
		}
		
		modifier = {
			factor = 0
			scope:secondary_recipient = {
				NOR = {
					has_relation_rival = scope:actor
					has_relation_nemesis = scope:actor
					is_at_war_with = scope:actor
				}
			}
		}
	}
}

send_to_inquisition_interaction = {
	category = interaction_category_heresy
	icon = send_to_inquisition

	desc = send_to_inquisition_interaction_desc

	is_shown = {
		scope:recipient = {
			is_imprisoned_by = scope:actor
		}

		scope:actor = {
			OR = {
				exists = faith.religious_head
				AND = {
					liege ?= { is_independent_ruler = yes }
					liege ?= { exists = cp:councillor_court_chaplain }
				}
			}
			faith = {
				has_doctrine = tenet_purge_of_heresy
				has_doctrine = doctrine_spiritual_head
			}
		}
	}

	is_valid_showing_failures_only = {
		scope:recipient = {
			age >= age_12_value
			custom_description = {
				text = "currently_being_tortured"
				NOT = { has_character_flag = is_being_tortured }
			}
		}
		scope:actor = {
			custom_description = {
				text = "hof_interaction_unreformed_faith"
				NOT = {
					faith = { has_doctrine_parameter = unreformed }
				}
			}
		}
	}

	is_highlighted = {
		OR = {
			scope:actor = { has_trait = sadistic }
			scope:actor = { has_trait = zealous }
			scope:actor = { has_trait = greedy }
			scope:actor = { has_relation_rival = scope:recipient }
		}
	}

	on_accept = {
		
		hidden_effect = {
			if = {
				limit = { scope:recipient = { has_character_modifier = allowed_to_go_outside } }
				scope:recipient = { remove_character_modifier = allowed_to_go_outside }
			}
			if = {
				limit = { scope:recipient = { has_character_modifier = moldy_gruel_diet } }
				scope:recipient = { remove_character_modifier = moldy_gruel_diet }
			}
			scope:recipient = {
				if = {
					limit = { exists = scope:actor.faith.religious_head }
					scope:actor.faith.religious_head = { save_scope_as = inquisitor }
				}
				else_if = {
					limit = {
						exists = scope:actor.liege.cp:councillor_court_chaplain
					}
					scope:actor.liege.cp:councillor_court_chaplain = {
						save_scope_as = inquisitor
					}
				}
				add_opinion = {
					modifier = sent_to_inquisition_opinion
					target = scope:actor
				}
				release_from_prison = yes
				add_character_flag = {
					flag = sent_to_inquisition
					days = 30
				}
				trigger_event = {
					id = wc_religious_interaction.1115
				}
			}
		}
		custom_tooltip = sent_to_inquisition_tt
		show_as_tooltip = {
			imprison_character_effect = {
				TARGET = scope:recipient
				IMPRISONER = scope:actor.faith.religious_head
			}
			scope:actor.faith.religious_head = {
				pay_short_term_gold = {
					target = scope:actor
					gold = medium_gold_value
				}
			}
			scope:actor = { add_piety = major_piety_gain }
		}
		scope:actor = {
			if = {
				limit = {
					exists = scope:actor.faith.religious_head
				}
				scope:actor.faith.religious_head = {
					save_scope_as = inquisitor
				}
			}
			else_if = {
				limit = {
					exists = scope:actor.liege.cp:councillor_court_chaplain
				}
				scope:actor.liege.cp:councillor_court_chaplain = {
					save_scope_as = inquisitor
				}
			}
			trigger_event = {
				id = wc_religious_interaction.1110
				days = 2
			}
		}
	}

	auto_accept = yes
	
	# AI
	ai_targets = {
		ai_recipients = prisoners
	}

	ai_frequency = 12

	ai_potential = {
		always = yes
	}

	ai_will_do = {
		base = 20
		modifier = {
			add = 30
			scope:actor = { has_trait = zealous }
		}
		modifier = {
			add = 45
			scope:actor = { has_trait = greedy }
		}
		modifier = {
			add = 30
			OR = {
				scope:actor = { has_trait = vengeful }
				scope:actor = { has_trait = wrathful }
			}
		}
		modifier = {
			add = 100
			scope:actor.ai_compassion < medium_positive_ai_value
			scope:actor = {
				opinion = {
					target = scope:recipient
					value <= high_negative_opinion
				}
			}
		}
	}
}