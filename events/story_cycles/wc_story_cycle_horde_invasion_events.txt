namespace = wc_horde_invasion

#########################################
#
#	Horde Invasion events - CK3 Edition
#
#########################################

#Spawns Troops for the Warchief
scripted_effect spawn_base_troops_warchief_effect = {
	spawn_horde_troops_effect = yes
	spawn_horde_troops_effect = yes
	spawn_horde_troops_effect = yes
}

scripted_effect spawn_base_troops_new_warchief_effect = {
	spawn_horde_troops_effect = yes
	spawn_horde_troops_effect = yes
}

# Setup Blackhand and the associated story
wc_horde_invasion.0001 = {
	scope = none
	hidden = yes

	trigger = {
		current_date >= 583.1.1
		dark_portal_was_opened_trigger = no
	}

	immediate = {
		add_to_global_variable_list = {
			name = wc_events_happened
			target = flag:dark_portal_was_opened
		}

		debug_log = "The Horde has appeared!"
		debug_log_date = yes

		title:e_horde.holder = {
			create_story = story_horde_invasion
			save_scope_as = story_owner
		}
	}
}

# Troops for the Horde
wc_horde_invasion.0002 = {
	type = character_event
	hidden = yes
	immediate = { spawn_orc_troops_based_on_culture_effect = yes }
}

# Troops for the Warchief
wc_horde_invasion.0003 = {
	type = character_event
	hidden = yes
	immediate = { spawn_base_troops_warchief_effect = yes }
}

# Troops for new Warchief
wc_horde_invasion.0004 = {
	type = character_event
	hidden = yes
	immediate = { spawn_base_troops_new_warchief_effect = yes }
}

##################
# Base Events
# 1000-1005
##################

# Starts the Horde Invasion
wc_horde_invasion.1000 = {
	type = character_event
	window = fullscreen_event
	title = {
		first_valid = {
			triggered_desc = {
				trigger = { is_medivh_trigger = yes }
				desc = wc_horde_invasion.medivh.1000.title
			}
			triggered_desc = {
				trigger = { is_from_draenor_trigger = yes }
				desc = wc_horde_invasion.orcish.1000.title
			}
			triggered_desc = {
				trigger = { feel_the_magic_in_world_trigger = yes }
				desc = wc_horde_invasion.magic.1000.title
			}
			desc = wc_horde_invasion.generic_close.1000.title
		}
	}
	desc = {
		first_valid = {
			triggered_desc = {  # Medivh opening the Dark Portal
				trigger = { is_medivh_trigger = yes }
				desc = wc_horde_invasion.medivh.1000.desc
			}
			triggered_desc = { # People from Draenor
				trigger = { is_from_draenor_trigger = yes }
				desc = wc_horde_invasion.draenor.1000.desc
			}
			triggered_desc = { # Creature attuned to magic feeling
				trigger = { feel_the_magic_in_world_trigger = yes }
				desc = wc_horde_invasion.magic.1000.desc
			}
			desc = wc_horde_invasion.generic_close.1000.desc # Basic fallback
		}
	}
	theme = war
	override_background = { # Medivh background
		trigger = { is_medivh_trigger = yes }
		reference = wc_fullscreen_dark_portal
	}
	override_background = { # Draenor background
		trigger = { is_from_draenor_trigger = yes }
		reference = wc_fullscreen_dark_portal
	}
	override_background = { # Magic background
		trigger = { 
			is_medivh_trigger = no
			is_from_draenor_trigger = no
			feel_the_magic_in_world_trigger = yes
		}
		reference = wc_fullscreen_dark_portal
	}
	override_background = { # Black Morass background
		trigger = { 
			is_medivh_trigger = no
			is_from_draenor_trigger = no
			feel_the_magic_in_world_trigger = no
		}
		reference = wc_fullscreen_dark_portal
	}

	# Base
	option = {
		trigger = {
			get_news_from_region_trigger = { REGION = world_eastern_kingdoms_azeroth }
			is_medivh_trigger = no
			feel_the_magic_in_world_trigger = no
			NOT = {
				OR = {
					has_title = title:e_horde
					has_title = title:k_shadow_council
					is_vassal_or_below_of = title:e_horde.holder
				}
			}
		}
		name = {
			text = {
				first_valid = {
					triggered_desc = {
						trigger = { is_from_draenor_not_horde_trigger = yes }
						desc = wc_horde_invasion.1000.draenor_not_horde
					}
					triggered_desc = {
						trigger = { has_title = title:k_stormwind }
						desc = wc_horde_invasion.1000.stormwind_king
					}
					desc = wc_horde_invasion.1000.generic_close
				}
			}
		}
		fallback = yes
	}

	# Medivh option
	option = {
		trigger = { is_medivh_trigger = yes }
		name = wc_horde_invasion.1000.medivh
	}

	# Magic option
	option = {
		trigger = {
			is_medivh_trigger = no
			is_from_draenor_trigger = no
			feel_the_magic_in_world_trigger = yes
		}
		name = wc_horde_invasion.1000.magic

		stress_impact = {
			base = minor_stress_impact_gain
		}
	}

	# Horde option
	option = {
		trigger = {
			NOT = { has_title = title:e_horde }
			OR = {
				has_title = title:k_shadow_council
				is_vassal_or_below_of = title:e_horde.holder
				is_landed = yes
			}
		}
		name = {
			text = {
				first_valid = {
					triggered_desc = {
						trigger = { has_title = title:k_shadow_council }
						desc = wc_horde_invasion.1000.orcish_warchief_and_shadowlord
					}
					triggered_desc = {
						trigger = { has_faith = faith:orcish_shamanism }
						desc = wc_horde_invasion.1000.orcish_shamanic
					}
					desc = wc_horde_invasion.1000.orcish
				}
			}
		}
		show_as_tooltip = { spawn_orc_troops_based_on_culture_effect = yes }
	}

	# Warchief option
	option = {
		trigger = { has_title = title:e_horde }
		name = wc_horde_invasion.1000.orcish_warchief_and_shadowlord
		show_as_tooltip = { spawn_base_troops_warchief_effect = yes }
	}
}

# Ends the Horde Invasion when enough lands taken
wc_horde_invasion.1001 = {
	type = character_event
	title = wc_horde_invasion.1001.title
	desc = wc_horde_invasion.1001.desc
	theme = war
	override_background = { reference = wc_background_dark_portal }
	left_portrait = root

	option = { # The orcs need their warchief!
		trigger = {
			trigger_if = {
				limit = { NOT = { has_game_rule = wc_collapse_of_the_first_horde_never } } # If has this gamerule, always available
				trigger_if = {
					limit = { NOT = { has_game_rule = wc_collapse_of_the_first_horde_always } }
					prestige_level >= max_prestige_level
				}
			trigger_else = { always = no }
			}
		}
		show_as_unavailable = { NOT = { has_game_rule = wc_collapse_of_the_first_horde_always } }
		
		name = wc_horde_invasion.1001.a
		
		if = {
			limit = {
				NOR = {
					has_game_rule = wc_collapse_of_the_first_horde_can_collapse_not
					has_game_rule = wc_collapse_of_the_first_horde_never
				}
			}
			custom_tooltip = wc_members_choice_the_first_horde_tooltip
			add_tyranny = 60

			save_scope_as = warchief
			every_vassal = { add_to_temporary_list = horde_vassals }

			every_in_list = { # Ask if you want to stay
				list = horde_vassals
				trigger_event = wc_horde_invasion.1002
			}
		}
		else = {
			custom_tooltip = wc_save_the_first_horde_tooltip
			
			if = {
				limit = { NOT = { has_game_rule = wc_collapse_of_the_first_horde_never } }
				add_tyranny = 90
			}
		}
		
		stress_impact = {
			ambitious = medium_stress_impact_loss
			greedy = medium_stress_impact_loss
			arbitrary = medium_stress_impact_loss
			just = medium_stress_impact_gain
			generous = medium_stress_impact_gain
			content = medium_stress_impact_gain
		}
		
		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_greed = 1
				ai_honor = -1
			}
			modifier = {
				add = 200
				has_trait = ambitious
			}
			modifier = { # Weight up for stress.
				add = 20
				has_trait = greedy
			}
			modifier = { # Weight up for stress.
				add = 20
				has_trait = arbitrary
			}
			modifier = { # Weight up for stress.
				add = -20
				has_trait = just
			}
			modifier = { # Weight up for stress.
				add = -20
				has_trait = generous
			}
			modifier = { # Weight up for stress.
				add = -20
				has_trait = content
			}
		}
	}
	
	option = { # We'll go our own way
		trigger = { NOT = { has_game_rule = wc_collapse_of_the_first_horde_never } }
		
		name = wc_horde_invasion.1001.b
		destroy_title_free_vassals_effect = { limit_size = minor_realm_size }

		ai_chance = {
			base = 200
			ai_value_modifier = {
				ai_greed = -1
				ai_compassion = 1
			}
		}
	}
}

# Vassals of the horde get choice - stay or leave
wc_horde_invasion.1002 = {
	type = character_event
	title = wc_horde_invasion.1002.title
	desc = wc_horde_invasion.1002.desc
	theme = war
	override_background = { reference = wc_background_dark_portal }
	left_portrait = scope:warchief

	option = { # Stay
		trigger = {
			OR = {
				is_ai = no
				culture = { has_cultural_pillar = heritage_orcish }
			}
		}
		name = {
			text = {
				first_valid = {
					triggered_desc = { # Orcs option
						trigger = { culture = { has_cultural_pillar = heritage_orcish } }
						desc = wc_horde_invasion.1002.orcish.a
					}
					desc = wc_horde_invasion.1002.a # Others
				}
			}
		}

		add_opinion = {
			target = scope:warchief
			opinion = 30
			modifier = respect_opinion
		}
		scope:warchief = {
			add_opinion = {
				target = root
				opinion = 30
				modifier = grateful_opinion
			}
		}

		stress_impact = {
			ambitious = medium_stress_impact_gain
			content = minor_stress_impact_loss
		}

		ai_chance = {
			base = 100
			ai_value_modifier = { ai_greed = -1 }
			opinion_modifier = {
				opinion_target = scope:warchief
				multiplier = 2
			}
			modifier = {
				add = 200
				has_trait = content
			}
			modifier = { # Weight up for stress.
				add = -20
				has_trait = ambitious
			}
			modifier = {
				factor = 3
				highest_held_title_tier = tier_county
			}
		}
	}

	option = { # Leave
		name = {
			text = {
				first_valid = {
					triggered_desc = { # Orcs option
						trigger = { culture = { has_cultural_pillar = heritage_orcish } }
						desc = wc_horde_invasion.1002.orcish.b
					}
					desc = wc_horde_invasion.1002.b # Others
				}
			}
		}

		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		becomes_independent = { change = scope:change }
		resolve_title_and_vassal_change = scope:change

		if = {
			limit = {
				OR = {
					is_ai = no
					culture = { has_cultural_pillar = heritage_orcish }
				}
			}
			scope:warchief = {
				add_opinion = {
					target = root
					modifier = treachery_opinion
					years = 30
				}
			}

			add_prestige = {
				value = medium_prestige_gain
				multiply = root.highest_held_title_tier
			}
			dynasty = {
				add_dynasty_prestige = {
					value = medium_dynasty_prestige_gain
					multiply = root.highest_held_title_tier
				}
			}
			stress_impact = {
				ambitious = minor_stress_impact_loss
				content = medium_stress_impact_gain
			}
		}
		
		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_greed = 1
				ai_boldness = 0.5
			}
			opinion_modifier = {
				opinion_target = scope:warchief
				multiplier = -2
			}
			modifier = {
				add = 200
				has_trait = ambitious
			}
			modifier = { # Weight up for stress.
				add = -20
				has_trait = content
			}
			modifier = {
				factor = 3
				highest_held_title_tier > tier_county
			}
			modifier = {
				factor = 3
				highest_held_title_tier > tier_duchy
			}
		}
	}
}

# The Horde is no more - notification
wc_horde_invasion.1003 = {
	type = character_event
	title = wc_horde_invasion.1003.title
	desc = wc_horde_invasion.1003.desc
	theme = war
	override_background = { reference = wc_background_dark_portal }
	left_portrait = scope:warchief

	option = { # Leave
		trigger = { culture = { has_cultural_pillar = heritage_orcish } }
		name = wc_horde_invasion.1003.a
	}
	option = {
		trigger = { NOT = { culture = { has_cultural_pillar = heritage_orcish } }}
		name = wc_horde_invasion.1003.b
	}
}

# Assault on Stormwind
wc_horde_invasion.1004 = {
	type = character_event
	title = wc_horde_invasion.1004.title
	desc = wc_horde_invasion.1004.desc
	theme = war

	override_background = { reference = wc_background_dark_portal }
	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	option = { # Lok'tar Ogar!
		name = wc_horde_invasion.1004.a
		declare_war_on_stormwind_effect = yes

		every_player = {
			limit = {
				is_landless_adventurer = no
				NOT = { has_title = title:e_horde }
				OR = {
					is_medivh_trigger = yes
					has_title = title:k_stormwind
					AND = {
						exists = title:k_stormwind.holder
						is_in_same_realm_as_target = { CHARACTER = title:k_stormwind.holder }
					}
					is_from_the_horde_trigger = yes
				}
			}
			trigger_event = wc_horde_invasion.1005
		}
	}
}

# Assault on Stormwind - Notification
wc_horde_invasion.1005 = {
	type = character_event
	title = wc_horde_invasion.1005.title
	desc = wc_horde_invasion.1005.desc
	theme = war

	override_background = { reference = wc_background_dark_portal }
	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	option = { # Lok'tar Ogar!
		name = wc_horde_invasion.1005.a
		show_as_tooltip = { declare_war_on_stormwind_effect = yes }
	}
}

######################
# Introduction Events
# 1500-1506
######################

# Blackhand Introduction
wc_horde_invasion.1500 = {
	type = character_event
	title = wc_horde_invasion.1500.title
	desc = wc_horde_invasion.1500.desc
	theme = war

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	option = { # We are going to destroy the world (canon)
		name = wc_horde_invasion.1500.a
	}

	option = { # Gul'dan has outlived his usefulness (not canon)
		name = wc_horde_invasion.1500.b
	}
}

# Gul'dan Introduction
wc_horde_invasion.1501 = {
	type = character_event
	title = wc_horde_invasion.1501.title
	desc = wc_horde_invasion.1501.desc
	theme = war

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	option = { # We are going to destroy the world (canon)
		name = wc_horde_invasion.1501.a
	}

	option = { # Blackhand will betray me (not canon)
		name = wc_horde_invasion.1501.b
	}
}

# Durotan Introduction
wc_horde_invasion.1502 = {
	type = character_event
	title = wc_horde_invasion.1502.title
	desc = wc_horde_invasion.1502.desc
	theme = war

	override_background = { reference = wc_background_dark_portal }
	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	option = { # Fuck you Guldan (canon)
		name = wc_horde_invasion.1502.a
	}

	option = { # I should follow the other clans (not canon)
		name = wc_horde_invasion.1502.b
	}
}

# Orgrim Doomhammer Introduction
wc_horde_invasion.1503 = {
	type = character_event
	title = wc_horde_invasion.1503.title
	desc = wc_horde_invasion.1503.desc
	theme = war

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	option = { # Path to glory (canon)
		name = wc_horde_invasion.1503.a
	}

	option = { # Durotan was right (not canon)
		name = wc_horde_invasion.1503.b
	}
}

# Kilrogg Introduction
wc_horde_invasion.1504 = {
	type = character_event
	title = wc_horde_invasion.1504.title
	desc = wc_horde_invasion.1504.desc
	theme = war

	left_portrait = {
		character = root
		animation = celebrate_axe
	}

	option = { # Explore the lands (canon)
		name = wc_horde_invasion.1504.a
	}

	option = { # Path to glory (not canon)
		name = wc_horde_invasion.1504.b
	}
}

# Cho'gall Introduction
wc_horde_invasion.1505 = {
	type = character_event
	title = wc_horde_invasion.1505.title
	desc = wc_horde_invasion.1505.desc
	theme = war

	override_background = { reference = throne_room_tribal }
	left_portrait = {
		character = root
		animation = personality_zealous
	}

	option = { # The Hour of Twilight come! (canon)
		name = wc_horde_invasion.1505.a

		show_as_tooltip = { set_character_secret_faith = faith:twilights_hammer_cult }
		make_character_crypto_religionist_effect = { CRYPTO_RELIGION = faith:twilights_hammer_cult }

		add_piety = 100

		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_zeal = -1
			}
		}
	}

	option = { # The Hour of Twilight is a scam (not canon)
		name = wc_horde_invasion.1505.b
	}
}

# Conversion of the other Twilight's Hammer
wc_horde_invasion.1506 = {
	type = character_event
	title = wc_horde_invasion.1506.title
	desc = wc_horde_invasion.1506.desc
	theme = war

	override_background = { reference = throne_room_tribal }
	left_portrait = {
		character = root
		animation = lunatic
	}

	option = { # The Hour of Twilight come!
		name = wc_horde_invasion.1506.a

		show_as_tooltip = { set_character_secret_faith = faith:twilights_hammer_cult }
		make_character_crypto_religionist_effect = { CRYPTO_RELIGION = faith:twilights_hammer_cult }

		add_piety = 50

		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_zeal = -1
			}
		}
	}

	option = { # I have new masters
		name = wc_horde_invasion.1506.b
	}
}

#################################
# Dragonmaw-Burning Blade Events
# 2000-2001
#################################

# Invites the Burning Blade and Dragonmaw clans - Delayer event
wc_horde_invasion.2000 = {
	type = character_event
	hidden = yes
	immediate = {
		invite_burning_blade_effect = yes
		invite_dragonmaw_effect = yes
		trigger_event = wc_horde_invasion.2001
	}
}

# Delayed event
wc_horde_invasion.2001 = {
	type = character_event
	title = wc_horde_invasion.2001.title
	desc = wc_horde_invasion.2001.desc
	theme = war
	override_background = { reference = wc_background_dark_portal }
	left_portrait = scope:zuluhed
	right_portrait = scope:dharl

	option = {
		name = LOKTAR_OGAR
		spawn_horde_troops_effect = yes
		spawn_horde_troops_effect = yes
	}
}

#################################
# Conquests of the Horde
# 9000-9002
#################################

# Conquering of Northshire # TODO: Change this to fullscreen event
wc_horde_invasion.9000 = {
	title = wc_horde_invasion.9000.title
	desc = wc_horde_invasion.9000.desc
	type = character_event
	theme = war
	
	override_background = { reference = burning_building }
	
	left_portrait = {
		character = root
		animation = celebrate_axe
	}
	
	#Kill them all!
	option = {
		trigger = { root = title:b_northshire.barony_controller }
		name = wc_horde_invasion.9000.a
		
		horde_bloodshed_effect = { LOCATION = scope:county }
		sack_county_effect = { LOCATION = scope:county }
		take_control_horde_effect = {
			PREVIOUS_HOLDER = title:c_northshire.holder
			NEW_TITLE = scope:county
		}
		change_culture_and_faith_horde_effect = yes
	}
	
	# Kill them all! - Notification
	option = {
		trigger = { NOT = { root = title:b_northshire.barony_controller } }
		name = wc_horde_invasion.9000.a
		show_as_tooltip = {
			horde_bloodshed_effect = { LOCATION = scope:county }
		}
	}
}

# Conquering of Northshire - Northshire side # TODO: Change this to fullscreen event
wc_horde_invasion.9001 = {
	title = wc_horde_invasion.9001.title
	desc = wc_horde_invasion.9001.desc
	type = character_event
	theme = war
	
	override_background = { reference = temple_church }
	
	right_portrait = {
		character = root
		animation = fear
	}
	
	#For Azeroth!
	option = {
		name = wc_horde_invasion.9001.a
		custom_tooltip = wc_horde_invasion.9001.tooltip.a
		
		show_as_tooltip = {
			horde_bloodshed_effect = { LOCATION = scope:county }
		}
	}
}

# Sacking of Northshire - Duchy
wc_horde_invasion.9002 = {
	title = wc_horde_invasion.9002.title
	desc = wc_horde_invasion.9002.desc
	type = character_event
	theme = war
	
	override_background = { reference = burning_building }
	
	left_portrait = {
		character = scope:new_holder
		animation = war_over_win
	}
	
	# Sack everything and capture the remnants
	option = {
		name = wc_horde_invasion.9002.a
		custom_tooltip = wc_horde_invasion.9002.tooltip.a
		
		sack_area_effect = { TITLE = title:d_northwoods }
		change_culture_and_faith_horde_area_effect = {
			TITLE = title:d_northwoods
			CHARACTER = scope:new_holder
		}
		
		ai_chance = {
			base = 150
		}
	}
	
	# Keep this untouched
	option = {
		name = wc_horde_invasion.9002.b
		custom_tooltip = wc_horde_invasion.9002.tooltip.b
		
		add_character_modifier = {
			modifier = brought_discipline_horde_modifier
			years = 2
		}	
		minor_sack_area_effect = { TITLE = title:d_northwoods }
		
		ai_chance = {
			base = 1
		}
	}
}